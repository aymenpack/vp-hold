<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Video Poker Assistant</title>

<style>
:root{
  --bg:#070b10;
  --panel:#0c121a;
  --border:#1b2a3d;
  --text:#eaf1fb;
  --muted:#b4c3d8;
  --accent:#2f6bff;
  --ok:#22c55e;
  --warn:#f59e0b;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial;
}
.app{
  max-width:980px;
  margin:auto;
  padding:12px 12px 120px;
}
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  margin-bottom:12px;
}
h2{
  margin:0 0 8px;
  font-size:14px;
  color:#cfe0ff;
}
.controls{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
select,button{
  background:var(--panel);
  color:var(--text);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  font-size:14px;
}
button.primary{
  background:var(--accent);
  border-color:var(--accent);
}
video,img,canvas{
  width:100%;
  border-radius:12px;
  border:1px solid var(--border);
  background:#000;
}
.hand{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:8px;
}
.card{
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px;
  text-align:center;
  font-size:18px;
}
.card.hold{
  outline:2px solid var(--ok);
}
.note{
  font-size:12px;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="app">

<!-- GAME / PAYTABLE -->
<div class="panel">
  <h2>Game</h2>
  <div class="controls">
    <select id="game">
      <option value="job">Jacks or Better</option>
      <option value="bonus">Bonus Poker</option>
      <option value="db">Double Bonus</option>
      <option value="ddb">Double Double Bonus</option>
      <option value="deuces">Deuces Wild</option>
      <option value="ux">Ultimate X</option>
      <option value="uxp">Ultimate X Progressive</option>
    </select>

    <select id="paytable">
      <option value="96">9/6 (Full Pay)</option>
      <option value="85">8/5</option>
    </select>
  </div>
</div>

<!-- CAMERA -->
<div class="panel">
  <h2>Camera</h2>
  <video id="video" playsinline autoplay muted style="display:none"></video>
  <img id="photo" style="display:none"/>
  <canvas id="canvas" style="display:none"></canvas>

  <div class="controls">
    <button class="primary" id="startCam">Start Camera</button>
    <button id="snap" disabled>Snap</button>
    <button id="clear">Clear</button>
  </div>

  <div class="note">
    Snap a photo of the machine.  
    Vision LLM will read the **bottom row** automatically for Ultimate X.
  </div>
</div>

<!-- HAND -->
<div class="panel">
  <h2>Hand</h2>
  <div class="hand" id="hand"></div>
  <div class="note" id="status">Waiting…</div>
</div>

</div>

<script>
/* ===============================
   STATE
=============================== */
let hand = [null,null,null,null,null];
let bestHold = [false,false,false,false,false];

const handEl = document.getElementById("hand");
const statusEl = document.getElementById("status");

/* ===============================
   RENDER
=============================== */
function renderHand(){
  handEl.innerHTML="";
  for(let i=0;i<5;i++){
    const c = hand[i];
    const d = document.createElement("div");
    d.className = "card";
    if(bestHold[i]) d.classList.add("hold");
    d.textContent = c ? `${c.r}${c.s}` : "—";
    d.onclick = () => openManualPicker(i);
    handEl.appendChild(d);
  }
}

/* ===============================
   CAMERA
=============================== */
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const photo = document.getElementById("photo");

document.getElementById("startCam").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject = stream;
  video.style.display="";
  document.getElementById("snap").disabled=false;
};

document.getElementById("snap").onclick = async () => {
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  const dataUrl = canvas.toDataURL("image/jpeg",0.9);
  photo.src = dataUrl;
  photo.style.display="";
  statusEl.textContent="Recognizing cards…";

  try{
    const cards = await recognizeWithVisionLLM(dataUrl);
    if(cards && cards.length === 5){
      hand = cards.map(c => ({ r: c.rank, s: c.suit }));
      computeHold();
      renderHand();
      statusEl.textContent="Done";
    }else{
      statusEl.textContent="Could not read cards. Tap to correct.";
    }
  }catch(e){
    statusEl.textContent="Recognition error";
  }
};

/* ===============================
   VISION LLM CALL
=============================== */
async function recognizeWithVisionLLM(imageDataUrl){
  const res = await fetch("/.netlify/functions/vision-llm",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ imageBase64:imageDataUrl })
  });
  const data = await res.json();
  return data.cards;
}

/* ===============================
   STRATEGY (simplified)
=============================== */
function computeHold(){
  // placeholder: hold all pairs or better
  bestHold = [false,false,false,false,false];
  const counts = {};
  hand.forEach(c => counts[c.r]=(counts[c.r]||0)+1);
  hand.forEach((c,i)=>{
    if(counts[c.r]>=2) bestHold[i]=true;
  });
}

/* ===============================
   MANUAL PICKER (fallback)
=============================== */
function openManualPicker(index){
  const val = prompt("Enter card (e.g. AS, 9D, KC):");
  if(!val || val.length<2) return;
  const r = val[0].toUpperCase();
  const s = val[1].toUpperCase();
  hand[index] = { r, s };
  computeHold();
  renderHand();
}

/* ===============================
   CLEAR
=============================== */
document.getElementById("clear").onclick = () => {
  hand = [null,null,null,null,null];
  bestHold = [false,false,false,false,false];
  renderHand();
  statusEl.textContent="Cleared";
};

renderHand();
</script>
</body>
</html>