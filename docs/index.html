<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate X – Vision UI</title>

<link rel="stylesheet" href="../capture/camera.css">

<style>
body{
  margin:0;
  background:#020617;
  color:#fff;
  font-family:system-ui;
}
.app{
  max-width:900px;
  margin:auto;
  padding:16px 16px 160px;
}
h2{margin:0}
.subtitle{font-size:14px;color:#9ca3af;margin-bottom:12px}

button{
  margin-top:18px;
  width:100%;
  padding:18px;
  font-size:20px;
  font-weight:900;
  background:#22c55e;
  color:#000;
  border:none;
  border-radius:18px;
  cursor:pointer;
}
button.secondary{
  background:#374151;
  color:#fff;
  font-size:14px;
  padding:12px;
}
button:disabled{opacity:.6}

/* CAMERA */
.scanner{
  position:relative;
  width:100%;
  height:42vh;
  max-height:420px;
  border-radius:20px;
  overflow:hidden;
  border:1px solid #1f2937;
  background:#000;
}
video{
  width:100%;
  height:100%;
  object-fit:contain;
}
.band{
  position:absolute;
  left:8%;
  right:8%;
  border:4px dashed #22c55e;
  border-radius:18px;
  pointer-events:none;
}
#status{margin-top:10px;font-size:14px;color:#9ca3af}
#debug{margin-top:12px;font-size:12px;white-space:pre-wrap;color:#9ca3af}
</style>
</head>

<body>
<div class="app">
  <h2>Ultimate X – Vision UI</h2>
  <div class="subtitle">Tap Start Camera first</div>

  <button id="startCamera">Start Camera</button>

  <div class="scanner" id="scanner" style="display:none">
    <video id="video" playsinline muted></video>
    <div class="band" id="band"></div>
  </div>

  <button id="snap" disabled>SNAP</button>

  <div id="status">Waiting for camera…</div>
  <pre id="debug"></pre>
</div>

<script type="module">
import {
  positionGreenFrame,
  captureBitmapFromGreenFrame
} from "../capture/capture.js";

const API_URL =
  "https://vp-hold-production.up.railway.app/analyze";

const startBtn = document.getElementById("startCamera");
const snapBtn = document.getElementById("snap");
const video = document.getElementById("video");
const band = document.getElementById("band");
const scanner = document.getElementById("scanner");
const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");

let stream = null;
let busy = false;

/* Start camera ONLY on user gesture */
startBtn.onclick = async () => {
  try {
    statusEl.textContent = "Starting camera…";

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = stream;
    await video.play();

    scanner.style.display = "block";
    startBtn.disabled = true;
    snapBtn.disabled = false;

    statusEl.textContent = "Camera ready";
    requestAnimationFrame(() => positionGreenFrame(scanner, band));
  } catch (e) {
    statusEl.textContent = "Camera error";
    debugEl.textContent = e.message || String(e);
  }
};

/* SNAP */
snapBtn.onclick = async () => {
  if (busy) return;
  busy = true;
  snapBtn.disabled = true;
  statusEl.textContent = "Processing…";

  try {
    const bitmap = await captureBitmapFromGreenFrame({
      video, band, scanner
    });

    const worker = new Worker("../ui/snapWorker.js", { type:"module" });

    worker.onmessage = (e) => {
      const { ok, data, error } = e.data;
      if (!ok) {
        statusEl.textContent = "Worker error";
        debugEl.textContent = error;
      } else {
        statusEl.textContent = "Done ✅";
        debugEl.textContent = JSON.stringify(data, null, 2);
      }
      worker.terminate();
      busy = false;
      snapBtn.disabled = false;
    };

    worker.postMessage({
      bitmap,
      workerUrl: API_URL,
      paytable: "DDB_9_6",
      mode: "conservative"
    }, [bitmap]);

  } catch (e) {
    statusEl.textContent = "Client error";
    debugEl.textContent = e.message || String(e);
    busy = false;
    snapBtn.disabled = false;
  }
};
</script>
</body>
</html>
