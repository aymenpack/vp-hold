<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ultimate X Triple Play</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#020617;
  --panel:rgba(2,6,23,.85);
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --blue:#38bdf8;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,-apple-system,system-ui;background:radial-gradient(circle at top,#020617,#000 70%);color:var(--text)}
.app{max-width:920px;margin:auto;padding:18px 16px 190px}
header{border-bottom:1px solid var(--border);padding-bottom:12px}
h1{margin:0;font-size:26px;font-weight:900}
.subtitle{font-size:13px;color:var(--muted);margin-top:4px}

.tabs{display:flex;gap:12px;margin-top:14px}
.tab{flex:1;padding:16px;border-radius:16px;border:1px solid var(--border);background:var(--panel);text-align:center;font-weight:900;cursor:pointer}
.tab.active{outline:3px solid var(--green);box-shadow:0 0 30px rgba(34,197,94,.6)}

.row{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
input,button{
  background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:14px;
  padding:12px 14px;font-size:14px
}
input{flex:1;min-width:90px}
button.primary{background:linear-gradient(180deg,var(--green),#16a34a);color:#000;border:none;font-weight:900;cursor:pointer}
button:disabled{opacity:.5;cursor:not-allowed}

.scanner{margin-top:18px;border-radius:22px;overflow:hidden;border:1px solid var(--border);position:relative}
video{width:100%;max-height:320px;object-fit:cover;background:black}
.band{position:absolute;left:0;right:0;border-top:2px dashed var(--blue);border-bottom:2px dashed var(--blue);pointer-events:none}

.status{font-size:12px;color:var(--muted);margin-top:8px;display:flex;align-items:center;gap:8px}
.spin{width:14px;height:14px;border:2px solid var(--muted);border-top-color:var(--green);border-radius:50%;animation:spin .8s linear infinite;display:none}
@keyframes spin{to{transform:rotate(360deg)}}

#error{margin-top:10px;padding:12px;border-radius:14px;background:#7f1d1d;display:none}
#cooldown{margin-top:8px;color:#facc15;display:none;font-size:13px}

.kpis{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
.kpi{padding:10px 14px;border-radius:999px;border:1px solid var(--border);background:var(--panel);font-size:13px;color:var(--muted)}
.kpi strong{color:#fff}
.badge{display:inline-block;padding:4px 10px;border-radius:999px;font-weight:900}
.badge.weighted{background:rgba(56,189,248,.18);border:1px solid rgba(56,189,248,.5)}
.badge.conv{background:rgba(250,204,21,.18);border:1px solid rgba(250,204,21,.6)}

#hand{display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-top:22px}
.card{border:1px solid var(--border);border-radius:18px;padding:20px 6px;text-align:center;background:var(--panel);position:relative}
.card.hold{outline:3px solid var(--green);box-shadow:0 0 30px rgba(34,197,94,.7);transform:translateY(-8px)}
.card.hold::after{content:"HOLD";position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--green);color:#000;font-size:11px;padding:4px 10px;border-radius:999px;font-weight:900}
.rank{font-size:28px;font-weight:900}
.suit{font-size:20px}
.red{color:var(--danger)}

#explain{margin-top:18px;padding:16px;border-radius:18px;border:1px solid var(--border);background:var(--panel);display:none;line-height:1.6}

#historyBtn{position:fixed;bottom:108px;right:18px;background:var(--panel);border:1px solid var(--border);border-radius:999px;padding:14px;font-size:18px;cursor:pointer}
#historyDrawer{position:fixed;left:0;right:0;bottom:0;height:60%;background:var(--panel);border-top:2px solid var(--border);border-radius:20px 20px 0 0;padding:16px;transform:translateY(100%);transition:.3s;overflow:auto}
#historyDrawer.open{transform:translateY(0)}
.historyItem{padding:10px;border-bottom:1px solid var(--border);font-size:14px}

footer{position:fixed;left:0;right:0;bottom:0;padding:16px;background:linear-gradient(180deg,transparent,#000 50%)}
#snap{width:100%;padding:18px;font-size:20px;border-radius:24px}
</style>
</head>

<body>
<div class="app">
<header>
  <h1>Ultimate X Triple Play</h1>
  <div class="subtitle">6/5 Bonus Poker Â· cards + 3 multipliers Â· token-optimized capture</div>
</header>

<div class="tabs">
  <div class="tab active" id="tabUX">Ultimate X</div>
  <div class="tab" id="tabUXP">Ultimate X Progressive</div>
</div>

<div class="row">
  <input id="m1" type="number" min="1" max="12" value="1" placeholder="Hand1 mult fallback">
  <input id="m2" type="number" min="1" max="12" value="1" placeholder="Hand2 mult fallback">
  <input id="m3" type="number" min="1" max="12" value="1" placeholder="Hand3 mult fallback">
</div>

<div class="scanner">
  <video id="video" autoplay playsinline muted></video>
  <div class="band" id="band"></div>
</div>

<div class="status" id="status"><div class="spin" id="spin"></div><span id="statusText">Starting cameraâ€¦</span></div>
<div id="cooldown"></div>
<div id="error"></div>

<div class="kpis">
  <div class="kpi">Detected: <strong id="detShow">â€”</strong></div>
  <div class="kpi">Used: <strong id="usedShow">â€”</strong></div>
  <div class="kpi">Total: <strong id="totalShow">â€”</strong></div>
  <div class="kpi">Mode: <strong id="modeBadge">â€”</strong></div>
</div>

<div class="kpis">
  <div class="kpi">EV single: <strong id="evSingle">â€”</strong></div>
  <div class="kpi">EV total: <strong id="evTotal">â€”</strong></div>
</div>

<div id="hand"></div>
<div id="explain"></div>
</div>

<div id="historyBtn">ðŸ§¾</div>
<div id="historyDrawer">
  <h3>Hand History</h3>
  <div id="historyList"></div>
</div>

<footer>
  <button id="snap" class="primary">ðŸŽ¯ SNAP</button>
</footer>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

/* Token-control knobs (big savings) */
const OUT_WIDTH = 360;        // smaller = cheaper
const JPEG_Q = 0.50;          // lower = cheaper
const COOLDOWN_SECONDS = 8;   // prevents accidental spam

/* Crop geometry (tuned for multiplier+cards row) */
const BAND_CENTER = 0.52;     // vertical center (fraction of video)
const BAND_HEIGHT = 0.30;     // height fraction of video
const LEFT_CROP = 0.10;       // keep left 10% margin for multipliers (increase if needed)
const RIGHT_CROP = 0.02;      // trim right edge slightly

/* ================= STATE ================= */
let mode = "ux";
let stream = null;
let busy = false;
let cooldown = 0;
let timer = null;
const history = [];

/* ================= ELEMENTS ================= */
const video=document.getElementById("video");
const band=document.getElementById("band");
const snapBtn=document.getElementById("snap");
const spin=document.getElementById("spin");
const statusText=document.getElementById("statusText");
const cooldownEl=document.getElementById("cooldown");
const errorEl=document.getElementById("error");

const m1=document.getElementById("m1");
const m2=document.getElementById("m2");
const m3=document.getElementById("m3");

const detShow=document.getElementById("detShow");
const usedShow=document.getElementById("usedShow");
const totalShow=document.getElementById("totalShow");
const modeBadge=document.getElementById("modeBadge");
const evSingle=document.getElementById("evSingle");
const evTotal=document.getElementById("evTotal");

const handDiv=document.getElementById("hand");
const explainDiv=document.getElementById("explain");

const tabUX=document.getElementById("tabUX");
const tabUXP=document.getElementById("tabUXP");

/* ================= HAPTICS ================= */
function haptic(type="light"){
  if(!navigator.vibrate) return;
  const map={ light:[10], medium:[20], success:[30,20,30], warning:[60] };
  navigator.vibrate(map[type]||[10]);
}

/* ================= TABS ================= */
tabUX.onclick=()=>{ mode="ux"; tabUX.classList.add("active"); tabUXP.classList.remove("active"); haptic("light"); };
tabUXP.onclick=()=>{ mode="uxp"; tabUXP.classList.add("active"); tabUX.classList.remove("active"); haptic("light"); };

/* ================= CAMERA ================= */
async function startCamera(){
  if(stream) return;
  try{
    stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }});
    video.srcObject = stream;
    statusText.textContent="Camera ready";
    requestAnimationFrame(updateBandOverlay);
  }catch(e){
    statusText.textContent="Camera permission denied";
  }
}
startCamera();

function updateBandOverlay(){
  const rect = video.getBoundingClientRect();
  const center = rect.height * BAND_CENTER;
  const h = rect.height * BAND_HEIGHT;
  band.style.top = (center - h/2) + "px";
  band.style.height = h + "px";
  requestAnimationFrame(updateBandOverlay);
}

/* ================= COOLDOWN ================= */
function startCooldown(){
  cooldown = COOLDOWN_SECONDS;
  snapBtn.disabled = true;
  cooldownEl.style.display="block";
  cooldownEl.textContent = `Cooldown ${cooldown}s`;
  timer = setInterval(()=>{
    cooldown--;
    cooldownEl.textContent = `Cooldown ${cooldown}s`;
    if(cooldown<=0){
      clearInterval(timer);
      snapBtn.disabled=false;
      cooldownEl.style.display="none";
    }
  },1000);
}

/* ================= HISTORY ================= */
function addHistory(entry){
  history.unshift(entry);
  if(history.length>10) history.pop();
  renderHistory();
}
function renderHistory(){
  const list=document.getElementById("historyList");
  list.innerHTML="";
  history.forEach(h=>{
    const d=document.createElement("div");
    d.className="historyItem";
    d.textContent=`${h.mode.toUpperCase()} Â· ${h.total}Ã— Â· ${h.cards.map(c=>c.rank+c.suit).join(" ")}`;
    d.onclick=()=>{
      renderHand(h.cards,h.hold);
      explainDiv.style.display="block";
      explainDiv.textContent=h.explanation;
    };
    list.appendChild(d);
  });
}
document.getElementById("historyBtn").onclick=()=>{
  document.getElementById("historyDrawer").classList.toggle("open");
  haptic("light");
};

/* ================= RENDER ================= */
function renderHand(cards, hold){
  handDiv.innerHTML="";
  cards.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="card"+(hold?.[i]?" hold":"");
    const red=c.suit==="H"||c.suit==="D";
    d.innerHTML=`<div class="rank ${red?"red":""}">${c.rank}</div><div class="suit ${red?"red":""}">${c.suit}</div>`;
    handDiv.appendChild(d);
  });
}
function setModeBadge(txt){
  if(txt==="WEIGHTED"){
    modeBadge.innerHTML = `<span class="badge weighted">WEIGHTED</span>`;
  } else if(txt==="CONVENTIONAL"){
    modeBadge.innerHTML = `<span class="badge conv">CONVENTIONAL</span>`;
  } else {
    modeBadge.textContent = txt || "â€”";
  }
}
function showError(msg){
  errorEl.style.display="block";
  errorEl.textContent=msg;
}
function clearError(){
  errorEl.style.display="none";
  errorEl.textContent="";
}

/* ================= TOKEN-OPTIMIZED CAPTURE ================= */
function captureOptimizedDataURL(){
  const vw=video.videoWidth, vh=video.videoHeight;
  if(!vw||!vh) return null;

  // 1) crop vertical band
  const bandH=Math.floor(vh * BAND_HEIGHT);
  const center=Math.floor(vh * BAND_CENTER);
  const top=Math.max(0, Math.min(vh-bandH, center - Math.floor(bandH/2)));

  // 2) crop horizontally to keep multiplier+cards only
  const left = Math.floor(vw * LEFT_CROP);
  const rightTrim = Math.floor(vw * RIGHT_CROP);
  const cropW = Math.max(1, vw - left - rightTrim);

  const crop=document.createElement("canvas");
  crop.width=cropW;
  crop.height=bandH;

  const ctx=crop.getContext("2d");
  ctx.drawImage(video, left, top, cropW, bandH, 0, 0, cropW, bandH);

  // 3) downscale to OUT_WIDTH
  const scale = OUT_WIDTH / cropW;
  const outW = OUT_WIDTH;
  const outH = Math.max(1, Math.floor(bandH * scale));

  const out=document.createElement("canvas");
  out.width=outW;
  out.height=outH;
  out.getContext("2d").drawImage(crop, 0, 0, outW, outH);

  return out.toDataURL("image/jpeg", JPEG_Q);
}

/* ================= SNAP ================= */
snapBtn.onclick = async()=>{
  if(busy || snapBtn.disabled) return;
  busy=true;
  haptic("light");
  clearError();
  spin.style.display="inline-block";
  statusText.textContent="Capturingâ€¦";

  await new Promise(r=>requestAnimationFrame(r));
  const img = captureOptimizedDataURL();
  if(!img){
    showError("Camera not ready");
    spin.style.display="none";
    busy=false;
    return;
  }

  statusText.textContent="Reading cards + 3 multipliersâ€¦";

  try{
    const res = await fetch(WORKER_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        imageBase64: img,
        mode,
        multipliers_fallback: [Number(m1.value||1), Number(m2.value||1), Number(m3.value||1)]
      })
    });
    const data = await res.json();

    if(data.error){
      showError(data.error + (data.detail?(" â€” "+data.detail):""));
      haptic("warning");
      statusText.textContent="Error";
    }else{
      haptic("medium");
      renderHand(data.cards, data.hold);
      detShow.textContent = (data.multipliers_detected||[]).map(x=>x??"â€”").join(" / ");
      usedShow.textContent = (data.multipliers_used||[]).join(" / ");
      totalShow.textContent = data.multiplier_total + "Ã—";
      setModeBadge(data.mode_badge);

      evSingle.textContent = (typeof data.ev_single==="number") ? data.ev_single.toFixed(4) : "â€”";
      evTotal.textContent = (typeof data.ev_total==="number") ? data.ev_total.toFixed(4) : "â€”";

      explainDiv.style.display="block";
      explainDiv.textContent = data.explanation;

      haptic("success");
      addHistory({
        mode,
        total: data.multiplier_total,
        cards: data.cards,
        hold: data.hold,
        explanation: data.explanation
      });

      statusText.textContent="Done";
    }
  }catch(e){
    showError("Network error");
    haptic("warning");
    statusText.textContent="Error";
  }

  spin.style.display="none";
  startCooldown();
  busy=false;
};
</script>
</body>
</html>
