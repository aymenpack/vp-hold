<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Video Poker Assistant</title>

<style>
:root{
  --bg:#0b0f14; --panel:#121a24; --border:#223043; --text:#e9eef6; --muted:#b7c3d7;
  --accent:#2f6bff; --ok:#22c55e; --warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui}
.app{max-width:900px;margin:auto;padding:12px 12px 160px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;margin-bottom:12px}
h2{margin:0 0 8px;font-size:14px;color:#cfe0ff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
select,button,input{
  background:#0f1621;color:#fff;border:1px solid var(--border);
  border-radius:12px;padding:10px;font-size:14px;
}
button.primary{background:var(--accent)}
video,canvas{width:100%;border-radius:12px;border:1px solid var(--border);background:#000}

.hand{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.card{
  border:1px solid var(--border);border-radius:14px;padding:12px 6px;
  text-align:center;position:relative;cursor:pointer;
  transition:.15s ease;
}
.card.hold{
  outline:3px solid var(--ok);
  box-shadow:0 0 14px rgba(34,197,94,.6);
  transform:translateY(-2px);
}
.card.warn{outline:3px solid var(--warn)}
.holdBadge{
  position:absolute;top:6px;right:6px;
  background:var(--ok);color:#000;font-size:10px;
  padding:2px 6px;border-radius:999px;font-weight:800;
}
.face{font-size:22px;font-weight:800}
.status{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.4}

.snapBtn{
  position:fixed;
  bottom:72px; /* â¬… moved higher */
  left:50%;
  transform:translateX(-50%);
  width:74px;height:74px;border-radius:50%;
  background:var(--accent);border:none;
  box-shadow:0 10px 30px rgba(47,107,255,.6);
}
.snapBtn::after{
  content:"";display:block;width:52px;height:52px;
  background:#fff;border-radius:50%;margin:auto;
}
.snapBtn:disabled{opacity:.5}

.footer{
  position:fixed;bottom:0;left:0;right:0;
  background:linear-gradient(transparent,var(--bg) 60%);
  padding:10px;
}
.footerInner{max-width:900px;margin:auto;display:grid;grid-template-columns:1fr 1fr;gap:10px}

.toast{
  position:fixed;top:20px;left:50%;transform:translateX(-50%);
  background:#22c55e;color:#000;
  padding:10px 16px;border-radius:999px;
  font-weight:700;display:none;
}
</style>
</head>

<body>
<div class="app">

<!-- GAME -->
<div class="panel">
  <h2>Game</h2>
  <div class="row">
    <select id="game">
      <option value="job">Jacks or Better</option>
      <option value="bonus">Bonus Poker</option>
      <option value="double_bonus">Double Bonus</option>
      <option value="ddb">Double Double Bonus</option>
      <option value="deuces">Deuces Wild</option>
      <option value="ux">Ultimate X</option>
      <option value="uxp">Ultimate X Progressive</option>
    </select>

    <select id="paytable">
      <option value="9/6">9/6</option>
      <option value="8/5">8/5</option>
      <option value="standard">Standard</option>
    </select>
  </div>
</div>

<!-- CAMERA -->
<div class="panel">
  <h2>Camera</h2>
  <video id="video" playsinline autoplay muted></video>
  <canvas id="canvas" style="display:none"></canvas>
  <div class="status" id="status">Ready. Tap Snap.</div>
</div>

<!-- HAND -->
<div class="panel">
  <div class="hand" id="hand"></div>
  <div class="status" id="confidenceMsg"></div>
</div>

</div>

<button class="snapBtn" id="snapBtn"></button>

<div class="footer">
  <div class="footerInner">
    <button id="retry">Retry</button>
    <button id="reset">Reset</button>
  </div>
</div>

<div class="toast" id="toast">ðŸ’° Donâ€™t forget Aymenâ€™s share ðŸ˜„</div>

<script>
/* ===== CONFIG ===== */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

/* ===== STATE ===== */
const SUIT={S:"â™ ",H:"â™¥",D:"â™¦",C:"â™£"};
let cards=[], hold=[], confidence=1, lastImage=null;

/* ===== ELEMENTS ===== */
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const handDiv=document.getElementById("hand");
const statusEl=document.getElementById("status");
const confMsg=document.getElementById("confidenceMsg");
const toast=document.getElementById("toast");

/* ===== CAMERA INIT ===== */
(async()=>{
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=s;
})();

/* ===== SNAP ===== */
snapBtn.onclick=async()=>{
  navigator.vibrate?.(30);

  // Full frame
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  const ctx=canvas.getContext("2d");
  ctx.drawImage(video,0,0);

  // ðŸ”¹ Crop horizontal band (cards area)
  const bandHeight = canvas.height * 0.4;
  const bandY = (canvas.height - bandHeight) / 2;

  const crop=document.createElement("canvas");
  crop.width=canvas.width;
  crop.height=bandHeight;
  crop.getContext("2d").drawImage(
    canvas,
    0, bandY, canvas.width, bandHeight,
    0, 0, canvas.width, bandHeight
  );

  // Resize to max width 800
  const sc=Math.min(800/crop.width,1);
  const out=document.createElement("canvas");
  out.width=crop.width*sc;
  out.height=crop.height*sc;
  out.getContext("2d").drawImage(crop,0,0,out.width,out.height);

  lastImage=out.toDataURL("image/jpeg",0.7);
  await recognize(lastImage);
};

retry.onclick=()=>lastImage&&recognize(lastImage);
reset.onclick=()=>{cards=[];hold=[];render();statusEl.textContent="Reset.";};

/* ===== RECOGNIZE ===== */
async function recognize(img){
  statusEl.textContent="Analyzing strategyâ€¦";
  const res=await fetch(WORKER_URL,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      imageBase64:img,
      game:game.value,
      paytable:paytable.value
    })
  });

  const d=await res.json();
  cards=d.cards||[];
  hold=d.hold||[false,false,false,false,false];
  confidence=d.confidence||1;

  render();
  statusEl.textContent="Done";

  if(confidence<0.7){
    confMsg.textContent="âš ï¸ Low confidence â€” verify holds";
  }else confMsg.textContent="";

  if(isWinningHand(cards)){
    toast.style.display="block";
    setTimeout(()=>toast.style.display="none",2500);
  }
}

/* ===== RENDER ===== */
function render(){
  handDiv.innerHTML="";
  cards.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="card"+(hold[i]?" hold":"")+(confidence<0.7?" warn":"");
    d.innerHTML=`
      ${hold[i]?'<div class="holdBadge">HOLD</div>':''}
      <div class="face">${c.rank}${SUIT[c.suit]}</div>
    `;
    d.onclick=()=>{hold[i]=!hold[i];render();};
    handDiv.appendChild(d);
  });
}

/* ===== WIN DETECTION ===== */
function isWinningHand(cards){
  if(cards.length!==5) return false;
  const counts={};
  cards.forEach(c=>counts[c.rank]=(counts[c.rank]||0)+1);
  return Object.values(counts).some(v=>v>=2);
}
</script>
</body>
</html>
