<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ultimate X Assistant</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#020617;
  --panel:rgba(2,6,23,.85);
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --green:#22c55e;
  --blue:#38bdf8;
  --danger:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,-apple-system,system-ui;
  background:radial-gradient(circle at top,#020617,#000 70%);
  color:var(--text);
}
.app{
  max-width:920px;
  margin:auto;
  padding:18px 16px 180px;
}

/* Header */
header{
  border-bottom:1px solid var(--border);
  padding-bottom:12px;
}
h1{margin:0;font-size:26px;font-weight:900}
.subtitle{font-size:13px;color:var(--muted)}

/* Tabs */
.tabs{display:flex;gap:12px;margin-top:14px}
.tab{
  flex:1;
  padding:16px;
  border-radius:16px;
  border:1px solid var(--border);
  background:var(--panel);
  text-align:center;
  font-weight:900;
  cursor:pointer;
}
.tab.active{
  outline:3px solid var(--green);
  box-shadow:0 0 30px rgba(34,197,94,.6);
}

/* Controls */
.row{display:flex;gap:12px;margin-top:16px}
input,button{
  background:var(--panel);
  color:var(--text);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
  font-size:15px;
}
input{flex:1}
button.primary{
  background:linear-gradient(180deg,var(--green),#16a34a);
  color:#000;
  border:none;
  font-weight:900;
}

/* Camera */
.scanner{
  margin-top:18px;
  border-radius:22px;
  overflow:hidden;
  border:1px solid var(--border);
  position:relative;
}
video{width:100%;max-height:320px;object-fit:cover;background:black}
.band{
  position:absolute;left:0;right:0;
  border-top:2px dashed var(--blue);
  border-bottom:2px dashed var(--blue);
}

/* KPIs */
.kpis{display:flex;gap:12px;margin-top:16px}
.kpi{
  padding:12px 18px;
  border-radius:999px;
  border:1px solid var(--border);
  background:var(--panel);
  font-size:14px;
}
.kpi strong{color:#fff}

/* Hand */
#hand{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:16px;
  margin-top:22px;
}
.card{
  border:1px solid var(--border);
  border-radius:18px;
  padding:20px 6px;
  text-align:center;
  background:var(--panel);
  position:relative;
}
.card.hold{
  outline:3px solid var(--green);
  box-shadow:0 0 30px rgba(34,197,94,.7);
  transform:translateY(-8px);
}
.card.hold::after{
  content:"HOLD";
  position:absolute;
  top:-10px;
  left:50%;
  transform:translateX(-50%);
  background:var(--green);
  color:#000;
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  font-weight:900;
}
.rank{font-size:28px;font-weight:900}
.suit{font-size:20px}
.red{color:var(--danger)}

/* Explanation */
#explain{
  margin-top:18px;
  padding:16px;
  border-radius:18px;
  border:1px solid var(--border);
  background:var(--panel);
  display:none;
}

/* History */
#historyBtn{
  position:fixed;
  bottom:96px;
  right:18px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:999px;
  padding:14px;
  font-size:18px;
  cursor:pointer;
}
#historyDrawer{
  position:fixed;
  left:0;right:0;bottom:0;
  height:60%;
  background:var(--panel);
  border-top:2px solid var(--border);
  border-radius:20px 20px 0 0;
  padding:16px;
  transform:translateY(100%);
  transition:.3s;
  overflow:auto;
}
#historyDrawer.open{transform:translateY(0)}
.historyItem{
  padding:10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
}

/* Footer */
footer{
  position:fixed;left:0;right:0;bottom:0;
  padding:16px;
  background:linear-gradient(180deg,transparent,#000 50%);
}
#snap{
  width:100%;
  padding:18px;
  font-size:20px;
  border-radius:24px;
}
</style>
</head>

<body>
<div class="app">
<header>
  <h1>Ultimate X Assistant</h1>
  <div class="subtitle">Vision Â· Multiplier Â· Strategy</div>
</header>

<div class="tabs">
  <div class="tab active" id="tabUX">Ultimate X</div>
  <div class="tab" id="tabUXP">Ultimate X Progressive</div>
</div>

<div class="row">
  <input id="fallbackMult" type="number" min="1" max="12" value="1">
</div>

<div class="scanner">
  <video id="video" autoplay playsinline muted></video>
  <div class="band"></div>
</div>

<div class="kpis">
  <div class="kpi">Multiplier: <strong id="multShow">â€”</strong></div>
  <div class="kpi">Source: <strong id="multSrc">â€”</strong></div>
</div>

<div id="hand"></div>
<div id="explain"></div>
</div>

<div id="historyBtn">ðŸ§¾</div>
<div id="historyDrawer">
  <h3>Hand History</h3>
  <div id="historyList"></div>
</div>

<footer>
  <button id="snap" class="primary">ðŸŽ¯ SNAP</button>
</footer>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";
const DOWNSCALE_WIDTH = 520;
const JPEG_QUALITY = 0.6;

/* ================= STATE ================= */
let mode = "ux";
let stream = null;
let busy = false;
const history = [];

/* ================= ELEMENTS ================= */
const video = document.getElementById("video");
const snapBtn = document.getElementById("snap");
const handDiv = document.getElementById("hand");
const explainDiv = document.getElementById("explain");
const fallbackMult = document.getElementById("fallbackMult");
const multShow = document.getElementById("multShow");
const multSrc = document.getElementById("multSrc");

/* ================= TABS ================= */
document.getElementById("tabUX").onclick = ()=>{
  mode="ux";
  tabUX.classList.add("active");
  tabUXP.classList.remove("active");
};
document.getElementById("tabUXP").onclick = ()=>{
  mode="uxp";
  tabUXP.classList.add("active");
  tabUX.classList.remove("active");
};

/* ================= CAMERA ================= */
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }});
  video.srcObject = stream;
}
startCamera();

/* ================= HAPTICS ================= */
function haptic(type="light"){
  if(!navigator.vibrate) return;
  const map={ light:[10], medium:[20], success:[30,20,30], warning:[60] };
  navigator.vibrate(map[type]||[10]);
}

/* ================= HISTORY ================= */
function addHistory(entry){
  history.unshift(entry);
  if(history.length>10) history.pop();
  renderHistory();
}
function renderHistory(){
  const list=document.getElementById("historyList");
  list.innerHTML="";
  history.forEach(h=>{
    const d=document.createElement("div");
    d.className="historyItem";
    d.textContent=`${h.mode.toUpperCase()} Â· ${h.multiplier}Ã— Â· ${h.cards.map(c=>c.rank+c.suit).join(" ")}`;
    d.onclick=()=>renderHand(h.cards,h.hold);
    list.appendChild(d);
  });
}
document.getElementById("historyBtn").onclick=()=>{
  document.getElementById("historyDrawer").classList.toggle("open");
  haptic("light");
};

/* ================= HELPERS ================= */
function cropBase64(){
  const vw=video.videoWidth, vh=video.videoHeight;
  const bandH=Math.floor(vh*0.35);
  const bandY=Math.floor((vh-bandH)/2);
  const c=document.createElement("canvas");
  c.width=vw; c.height=bandH;
  c.getContext("2d").drawImage(video,0,bandY,vw,bandH,0,0,vw,bandH);
  const out=document.createElement("canvas");
  const scale=DOWNSCALE_WIDTH/vw;
  out.width=DOWNSCALE_WIDTH;
  out.height=Math.floor(bandH*scale);
  out.getContext("2d").drawImage(c,0,0,out.width,out.height);
  return out.toDataURL("image/jpeg",JPEG_QUALITY);
}
function renderHand(cards,hold){
  handDiv.innerHTML="";
  cards.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="card"+(hold[i]?" hold":"");
    const red=c.suit==="H"||c.suit==="D";
    d.innerHTML=`<div class="rank ${red?"red":""}">${c.rank}</div><div class="suit ${red?"red":""}">${c.suit}</div>`;
    handDiv.appendChild(d);
  });
}

/* ================= SNAP ================= */
snapBtn.onclick = async ()=>{
  if(busy) return;
  busy=true;
  haptic("light");

  const img=cropBase64();
  const res=await fetch(WORKER_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      imageBase64: img,
      mode,
      multiplier:Number(fallbackMult.value||1)
    })
  });
  const data=await res.json();

  if(!data.error){
    haptic("medium");
    renderHand(data.cards,data.hold);
    multShow.textContent=data.multiplier_used+"Ã—";
    multSrc.textContent=data.multiplier_detected?"vision":"manual";
    explainDiv.style.display="block";
    explainDiv.textContent=data.explanation;
    haptic("success");
    addHistory({
      cards:data.cards,
      hold:data.hold,
      multiplier:data.multiplier_used,
      mode
    });
  }else{
    haptic("warning");
  }
  busy=false;
};
</script>
</body>
</html>
