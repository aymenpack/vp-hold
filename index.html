<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate X Capture Test</title>

<style>
body {
  margin:0;
  font-family:system-ui;
  background:#020617;
  color:#fff;
}
.app {
  max-width:900px;
  margin:auto;
  padding:16px;
}
video {
  width:100%;
  max-height:360px;
  object-fit:cover;
  background:#000;
  border-radius:16px;
}
.overlay {
  position:absolute;
  left:0; right:0;
  border:2px dashed #22c55e;
  pointer-events:none;
}
button {
  margin-top:12px;
  width:100%;
  padding:16px;
  font-size:18px;
  font-weight:bold;
  background:#22c55e;
  color:#000;
  border:none;
  border-radius:14px;
}
.preview img {
  margin-top:12px;
  width:100%;
  border-radius:12px;
  border:1px solid #333;
}
.log {
  margin-top:10px;
  font-size:12px;
  color:#9ca3af;
  white-space:pre-wrap;
}
</style>
</head>

<body>
<div class="app">
  <h2>Ultimate X â€“ Capture Debug</h2>
  <p>This shows exactly what will be sent to vision.</p>

  <div style="position:relative">
    <video id="video" autoplay playsinline muted></video>
    <div class="overlay" id="overlay"></div>
  </div>

  <button id="snap">SNAP (Preview Only)</button>

  <div class="preview">
    <img id="preview">
  </div>

  <div class="log" id="log"></div>
</div>

<script>
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const preview = document.getElementById("preview");
const log = document.getElementById("log");
const snap = document.getElementById("snap");

// Start camera automatically
navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }})
  .then(stream => {
    video.srcObject = stream;
    requestAnimationFrame(updateOverlay);
  })
  .catch(e => log.textContent = "Camera error: " + e.message);

// Overlay covers ALL 3 rows (approx 60% of height)
function updateOverlay(){
  const r = video.getBoundingClientRect();
  const h = r.height * 0.60;
  overlay.style.top = (r.height*0.20) + "px";
  overlay.style.height = h + "px";
  requestAnimationFrame(updateOverlay);
}

snap.onclick = async () => {
  await new Promise(r=>requestAnimationFrame(r));

  const vw = video.videoWidth;
  const vh = video.videoHeight;
  if(!vw || !vh){
    log.textContent = "Camera not ready";
    return;
  }

  // CAPTURE: full width, 60% height centered lower
  const captureTop = Math.floor(vh * 0.20);
  const captureH = Math.floor(vh * 0.60);

  const canvas = document.createElement("canvas");
  canvas.width = vw;
  canvas.height = captureH;

  canvas.getContext("2d").drawImage(
    video,
    0, captureTop, vw, captureH,
    0, 0, vw, captureH
  );

  // Downscale slightly but KEEP DETAIL
  const outW = 900;
  const outH = Math.floor(captureH * (outW / vw));
  const out = document.createElement("canvas");
  out.width = outW;
  out.height = outH;
  out.getContext("2d").drawImage(canvas, 0, 0, outW, outH);

  const img = out.toDataURL("image/jpeg", 0.85);
  preview.src = img;

  log.textContent =
    "Captured image size:\n" +
    `${outW} x ${outH}\n\n` +
    "Visually inspect above:\n" +
    "- Do you see ALL 3 rows?\n" +
    "- Do you see multipliers on the left?\n" +
    "- Do you see the bottom row cards clearly?";
};
</script>
</body>
</html>
