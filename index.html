<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Ultimate X Assistant – YOLO</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Inter;background:#020617;color:#e5e7eb}
.app{max-width:900px;margin:auto;padding:16px 16px 120px}
h1{margin:0;font-size:20px;font-weight:900}
.subtitle{font-size:13px;color:#9ca3af;margin-top:4px}

.scanner{margin-top:12px;border-radius:16px;overflow:hidden;border:1px solid #374151}
video{width:100%;max-height:280px;object-fit:cover;background:black}

.status{font-size:12px;color:#9ca3af;margin-top:8px}

#hand{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-top:16px}
.card{border:1px solid #374151;border-radius:14px;padding:14px;text-align:center;background:#020617}
.rank{font-size:22px;font-weight:900}
.suit{font-size:18px}
.red{color:#ef4444}

footer{position:fixed;left:0;right:0;bottom:0;padding:12px 16px;background:#020617}
button{width:100%;padding:14px;font-size:16px;border-radius:14px;background:#22c55e;color:#000;font-weight:900;border:none}
button:disabled{opacity:.5}
</style>
</head>

<body>
<div class="app">
  <h1>Ultimate X Assistant</h1>
  <div class="subtitle">YOLO pretrained vision (Roboflow workflow)</div>

  <div class="scanner">
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div class="status" id="status">Camera ready</div>
  <div id="hand"></div>
</div>

<footer>
  <button id="snap">SNAP</button>
</footer>

<script>
/* =====================
   CONFIG – YOUR WORKFLOW
===================== */
const ROBOFLOW_ENDPOINT =
  "https://serverless.roboflow.com/vp-onhnx/workflows/custom-workflow";

const ROBOFLOW_API_KEY = "XwDKa49dFzOqokOV1qIT";

/* ===================== */

const video = document.getElementById("video");
const snapBtn = document.getElementById("snap");
const statusEl = document.getElementById("status");
const handDiv = document.getElementById("hand");

let stream=null;

async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"environment" }
  });
  video.srcObject = stream;
}
startCamera();

snapBtn.onclick = async ()=>{
  snapBtn.disabled = true;
  statusEl.textContent = "Detecting cards…";

  const vw = video.videoWidth;
  const vh = video.videoHeight;
  if(!vw || !vh){
    statusEl.textContent = "Camera not ready";
    snapBtn.disabled = false;
    return;
  }

  const bandH = Math.floor(vh * 0.40);
  const bandY = Math.floor((vh - bandH) / 2);

  const canvas = document.createElement("canvas");
  canvas.width = vw;
  canvas.height = bandH;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, bandY, vw, bandH, 0, 0, vw, bandH);

  const base64 = canvas
    .toDataURL("image/jpeg", 0.8)
    .split(",")[1];

  try{
    const res = await fetch(ROBOFLOW_ENDPOINT, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-api-key": ROBOFLOW_API_KEY
      },
      body: JSON.stringify({
        inputs: {
          image: {
            type: "base64",
            value: base64
          }
        }
      })
    });

    const data = await res.json();
    console.log("Roboflow response:", data);

    if(!data.outputs || !data.outputs[0]?.predictions){
      statusEl.textContent = "No cards detected";
      snapBtn.disabled = false;
      return;
    }

    const preds = data.outputs[0].predictions;

    const cards = preds
      .sort((a,b)=>a.x - b.x)
      .slice(0,5)
      .map(p => parseCardLabel(p.class));

    renderHand(cards);
    statusEl.textContent = "Done";

  }catch(e){
    console.error(e);
    statusEl.textContent = "Detection failed";
  }

  snapBtn.disabled = false;
};

function parseCardLabel(label){
  const suitChar = label.slice(-1).toUpperCase();
  let rank = label.slice(0, -1).toUpperCase();
  if(rank === "10") rank = "T";
  return { rank, suit: suitChar };
}

function renderHand(cards){
  handDiv.innerHTML = "";
  cards.forEach(c=>{
    const d = document.createElement("div");
    d.className = "card";
    const red = c.suit==="H" || c.suit==="D";
    d.innerHTML = `
      <div class="rank ${red?"red":""}">${c.rank}</div>
      <div class="suit ${red?"red":""}">${c.suit}</div>
    `;
    handDiv.appendChild(d);
  });
}
</script>
</body>
</html>
