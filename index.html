<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>VP Assistant</title>

<style>
/* ================= THEMES ================= */
body[data-theme="casino"]{
  --bg:#07140e; --panel:#0f2318; --panel2:#0b1a12; --border:#1e3a2a;
  --text:#e9f6ef; --muted:#9fc7b2;
  --accent:#1aff8c; --hold:#22c55e;
}
body[data-theme="dark"]{
  --bg:#0b0f14; --panel:#121a24; --panel2:#0e141d; --border:#223043;
  --text:#e9eef6; --muted:#b7c3d7;
  --accent:#2f6bff; --hold:#3b82f6;
}
body[data-theme="neon"]{
  --bg:#0b0020; --panel:#16002f; --panel2:#0f0022; --border:#3f007d;
  --text:#f3e8ff; --muted:#c4b5fd;
  --accent:#d946ef; --hold:#22ffcc;
}
body[data-theme="bright"]{
  --bg:#f4f6f8; --panel:#ffffff; --panel2:#f1f5f9; --border:#d0d7de;
  --text:#111827; --muted:#4b5563;
  --accent:#2563eb; --hold:#16a34a;
}

/* ================= BASE ================= */
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,system-ui;
}
.app{max-width:900px;margin:auto;padding:12px 12px 140px}
.panel{
  background:linear-gradient(180deg,var(--panel),var(--panel2));
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
  margin-bottom:12px;
}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
.title{font-size:16px;font-weight:900}
.sub{font-size:12px;color:var(--muted)}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{
  border:1px solid var(--border);
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
}
.chip strong{color:var(--text)}
.iconBtn{
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  padding:8px 12px;
  border-radius:999px;
}

/* ================= SCANNER ================= */
.scanWrap{
  position:relative;
  height:180px;
  border-radius:16px;
  overflow:hidden;
  border:1px solid var(--border);
  user-select:none;
  touch-action:manipulation;
}
.scanWrap video{
  position:absolute;
  width:100%;
  top:50%;
  transform:translateY(-50%);
}
.scanMask{
  position:absolute;inset:0;
  background:linear-gradient(180deg,rgba(0,0,0,.55),rgba(0,0,0,.05) 35%,rgba(0,0,0,.05) 65%,rgba(0,0,0,.55));
}
.scanWindow{
  position:absolute;left:12px;right:12px;top:32%;height:36%;
  border:2px dashed rgba(255,255,255,.25);
  border-radius:14px;
}
.scanText{
  position:absolute;left:50%;top:50%;
  transform:translate(-50%,-50%);
  text-align:center;font-weight:900;
}
.scanText small{display:block;font-weight:600;color:var(--muted);margin-top:6px}

/* ================= HAND ================= */
.hand{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.card{
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px 6px;
  text-align:center;
  position:relative;
}
.card.hold{
  outline:3px solid var(--hold);
  box-shadow:0 0 18px var(--hold);
  transform:translateY(-4px);
}
.card.red{color:#ef4444}
.card.black{color:var(--text)}
.rank{font-size:22px;font-weight:900}
.suit{font-size:18px}
.badge{
  position:absolute;top:8px;right:8px;
  background:var(--hold);color:#000;
  font-size:10px;font-weight:900;
  padding:2px 8px;border-radius:999px;
}

/* ================= SETTINGS ================= */
.sheetBack{
  position:fixed;inset:0;
  display:none;
  background:rgba(0,0,0,.55);
  z-index:1200;
}
.sheet{
  position:absolute;bottom:0;left:0;right:0;
  max-width:900px;margin:auto;
  height:85vh;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px 18px 0 0;
  padding:12px;
  overflow:auto;
}
.section{margin-top:14px}
.section h3{margin:0 0 8px;font-size:13px;color:var(--muted)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tile{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
}
.tile.active{
  border-color:var(--accent);
  box-shadow:0 0 0 4px rgba(0,0,0,.15);
}

/* ================= OVERLAY + TOAST ================= */
.overlay{
  position:fixed;inset:0;
  display:none;
  align-items:center;justify-content:center;
  background:rgba(0,0,0,.55);
  z-index:1000;
}
.loader{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
  text-align:center;
  width:min(340px, 92vw);
}
.spinner{
  width:32px;height:32px;
  border:3px solid rgba(255,255,255,.2);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin 1s linear infinite;
  margin:0 auto 10px;
}
@keyframes spin{to{transform:rotate(360deg)}}
.toast{
  position:fixed;top:18px;left:50%;
  transform:translateX(-50%);
  display:none;
  background:var(--hold);color:#000;
  font-weight:900;
  padding:10px 16px;border-radius:999px;
  z-index:1100;
}
</style>
</head>

<body data-theme="neon">
<div class="app">

<!-- TOP -->
<div class="panel">
  <div class="hrow">
    <div>
      <div class="title">VP Assistant</div>
      <div class="sub" id="subtitle">Tap scanner to snap</div>
    </div>
    <button class="iconBtn" id="openSettings">‚öôÔ∏è</button>
  </div>
  <div class="chips" style="margin-top:10px">
    <div class="chip">Game: <strong id="chipGame"></strong></div>
    <div class="chip">Paytable: <strong id="chipPay"></strong></div>
    <div class="chip" id="chipMult" style="display:none">Mult: <strong id="chipMultVal"></strong></div>
    <div class="chip">Theme: <strong id="chipTheme"></strong></div>
  </div>
</div>

<!-- SCANNER -->
<div class="panel">
  <div class="scanWrap" id="scanWrap">
    <video id="video" playsinline autoplay muted></video>
    <div class="scanMask"></div>
    <div class="scanWindow"></div>
    <div class="scanText">
      Align the 5 cards here
      <small>Tap anywhere to scan</small>
    </div>
  </div>
  <div class="sub" id="status" style="margin-top:8px">Starting camera‚Ä¶</div>
</div>

<!-- RESULT -->
<div class="panel">
  <div class="hand" id="hand"></div>
</div>

</div>

<canvas id="canvas" style="display:none"></canvas>

<div class="overlay" id="overlay">
  <div class="loader">
    <div class="spinner"></div>
    <div style="font-weight:900;margin-bottom:6px">Analyzing‚Ä¶</div>
    <div class="sub" id="overlayMsg">Reading cards & deciding holds</div>
  </div>
</div>

<div class="toast" id="toast">üí∞ Don‚Äôt forget Aymen‚Äôs share üòÑ</div>

<!-- SETTINGS -->
<div class="sheetBack" id="sheetBack">
  <div class="sheet">
    <div class="hrow">
      <h2>Settings</h2>
      <button class="iconBtn" id="closeSettings">Close</button>
    </div>

    <div class="section">
      <h3>Game</h3>
      <div class="grid" id="gameGrid"></div>
    </div>

    <div class="section">
      <h3>Paytable</h3>
      <div class="grid" id="payGrid"></div>
    </div>

    <div class="section" id="multSection" style="display:none">
      <h3>Ultimate X Multiplier</h3>
      <div class="grid" id="multGrid"></div>
      <div class="sub" style="margin-top:8px">Auto-detected when visible (high confidence). Tap to override.</div>
    </div>

    <div class="section">
      <h3>Theme</h3>
      <div class="grid" id="themeGrid"></div>
    </div>

    <div class="section">
      <h3>Battery</h3>
      <div class="sub">Camera stops automatically when you leave the page.</div>
      <button class="iconBtn" id="stopCamBtn" style="margin-top:10px">Stop camera now</button>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

/* ================= DATA ================= */
const SUIT={S:"‚ô†",H:"‚ô•",D:"‚ô¶",C:"‚ô£"};
const GAMES=[
  {k:"job",n:"Jacks or Better"},
  {k:"bonus",n:"Bonus Poker"},
  {k:"double_bonus",n:"Double Bonus"},
  {k:"ddb",n:"Double Double Bonus"},
  {k:"deuces",n:"Deuces Wild"},
  {k:"ux",n:"Ultimate X"},
];
const PAYTABLES={
  job:["9/6","8/5"],
  bonus:["standard"],
  double_bonus:["standard"],
  ddb:["standard"],
  deuces:["standard"],
  ux:["standard"]
};
const THEMES=["casino","dark","neon","bright"];
const MULTS=[1,2,3,4,5,8,10,12];

/* ================= STATE ================= */
const state={
  game:localStorage.getItem("game")||"job",
  paytable:localStorage.getItem("paytable")||"9/6",
  theme:localStorage.getItem("theme")||"neon",
  multiplier:Number(localStorage.getItem("multiplier")||1),
  cards:[],hold:[],
  stream:null,
  busy:false
};

/* ================= ELEMENTS ================= */
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const scanWrap=document.getElementById("scanWrap");
const statusEl=document.getElementById("status");
const handDiv=document.getElementById("hand");
const overlay=document.getElementById("overlay");
const overlayMsg=document.getElementById("overlayMsg");
const toast=document.getElementById("toast");

const chipGame=document.getElementById("chipGame");
const chipPay=document.getElementById("chipPay");
const chipTheme=document.getElementById("chipTheme");
const chipMult=document.getElementById("chipMult");
const chipMultVal=document.getElementById("chipMultVal");

const sheetBack=document.getElementById("sheetBack");
const gameGrid=document.getElementById("gameGrid");
const payGrid=document.getElementById("payGrid");
const multGrid=document.getElementById("multGrid");
const multSection=document.getElementById("multSection");
const themeGrid=document.getElementById("themeGrid");
const stopCamBtn=document.getElementById("stopCamBtn");

/* ================= INIT ================= */
document.body.dataset.theme=state.theme;
normalizePaytable();
renderChips();
renderSettings();
renderHand();
startCamera();

/* ================= CAMERA ================= */
async function startCamera(){
  if(state.stream) return;
  try{
    state.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject=state.stream;
    await waitForVideo();
    statusEl.textContent="Ready ‚Äî tap scanner";
  }catch(e){
    statusEl.textContent="Camera permission needed.";
  }
}
function stopCamera(){
  if(!state.stream) return;
  state.stream.getTracks().forEach(t=>t.stop());
  state.stream=null;
  video.srcObject=null;
  statusEl.textContent="Camera stopped";
}
stopCamBtn.onclick=stopCamera;
document.addEventListener("visibilitychange",()=>document.hidden?stopCamera():startCamera());

async function waitForVideo(){
  const t0=Date.now();
  while(true){
    if(video.readyState>=2 && video.videoWidth>0 && video.videoHeight>0) return;
    if(Date.now()-t0>3000) return;
    await new Promise(r=>setTimeout(r,50));
  }
}

/* ================= SNAP ================= */
scanWrap.addEventListener("pointerdown", async (e)=>{
  e.preventDefault();
  await safeSnap();
},{passive:false});

async function safeSnap(){
  if(state.busy) return;
  state.busy=true;
  overlay.style.display="flex";
  overlayMsg.textContent="Reading cards & deciding holds‚Ä¶";
  try{
    if(!state.stream) await startCamera();
    await waitForVideo();
    if(video.videoWidth===0){ throw new Error("Video not ready"); }

    const img=captureBand();

    const res=await fetch(WORKER_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        imageBase64:img,
        game:state.game,
        paytable:state.paytable,
        multiplier:state.multiplier
      })
    });

    const data=await res.json();
    state.cards=data.cards||[];
    state.hold=data.hold||[false,false,false,false,false];

    // auto multiplier detect only for UX and only if confident
    if(state.game==="ux" && data.multiplier && data.confidence>=0.75){
      state.multiplier=Number(data.multiplier)||state.multiplier;
      localStorage.setItem("multiplier",state.multiplier);
    }

    renderHand();
    renderChips();

    if(isWin(state.cards)){
      toast.style.display="block";
      setTimeout(()=>toast.style.display="none",2000);
    }

  }catch(err){
    console.error(err);
    statusEl.textContent="Scan failed ‚Äî try again";
  }finally{
    overlay.style.display="none";
    state.busy=false;
  }
}

function captureBand(){
  const vw=video.videoWidth,vh=video.videoHeight;
  const bandH=vh*0.35,bandY=(vh-bandH)/2;

  canvas.width=vw;
  canvas.height=bandH;
  canvas.getContext("2d").drawImage(video,0,bandY,vw,bandH,0,0,vw,bandH);

  const sc=Math.min(900/vw,1);
  const out=document.createElement("canvas");
  out.width=Math.round(vw*sc);
  out.height=Math.round(bandH*sc);
  out.getContext("2d").drawImage(canvas,0,0,out.width,out.height);
  return out.toDataURL("image/jpeg",0.7);
}

/* ================= RENDER HAND ================= */
function renderHand(){
  handDiv.innerHTML="";
  if(!state.cards.length) return;
  state.cards.forEach((c,i)=>{
    const red=(c.suit==="H"||c.suit==="D");
    const d=document.createElement("div");
    d.className=`card ${state.hold[i]?"hold":""} ${red?"red":"black"}`;
    d.innerHTML=`
      ${state.hold[i]?'<div class="badge">HOLD</div>':''}
      <div class="rank">${c.rank}</div>
      <div class="suit">${SUIT[c.suit]}</div>
    `;
    d.onclick=()=>{state.hold[i]=!state.hold[i];renderHand();};
    handDiv.appendChild(d);
  });
}

function isWin(cards){
  if(!cards || cards.length!==5) return false;
  const m={};
  cards.forEach(c=>m[c.rank]=(m[c.rank]||0)+1);
  return Object.values(m).some(v=>v>=2);
}

/* ================= SETTINGS ================= */
document.getElementById("openSettings").onclick=()=>{
  renderSettings();
  sheetBack.style.display="block";
};
document.getElementById("closeSettings").onclick=()=>{
  sheetBack.style.display="none";
};
sheetBack.addEventListener("click",(e)=>{ if(e.target===sheetBack) sheetBack.style.display="none"; });

function normalizePaytable(){
  const allowed=PAYTABLES[state.game]||["standard"];
  if(!allowed.includes(state.paytable)){
    state.paytable=allowed[0];
    localStorage.setItem("paytable",state.paytable);
  }
}

function renderSettings(){
  // GAME
  gameGrid.innerHTML="";
  GAMES.forEach(g=>{
    const t=document.createElement("div");
    t.className="tile"+(g.k===state.game?" active":"");
    t.innerHTML=`<div class="name">${g.n}</div>`;
    t.onclick=()=>{
      state.game=g.k;
      localStorage.setItem("game",state.game);
      normalizePaytable();
      renderSettings();
      renderChips();
    };
    gameGrid.appendChild(t);
  });

  // PAYTABLE
  payGrid.innerHTML="";
  (PAYTABLES[state.game]||["standard"]).forEach(p=>{
    const t=document.createElement("div");
    t.className="tile"+(p===state.paytable?" active":"");
    t.innerHTML=`<div class="name">${p}</div>`;
    t.onclick=()=>{
      state.paytable=p;
      localStorage.setItem("paytable",state.paytable);
      renderSettings();
      renderChips();
    };
    payGrid.appendChild(t);
  });

  // MULTIPLIER (Ultimate X only)
  if(state.game==="ux"){
    multSection.style.display="";
    multGrid.innerHTML="";
    MULTS.forEach(m=>{
      const t=document.createElement("div");
      t.className="tile"+(state.multiplier===m?" active":"");
      t.innerHTML=`<div class="name">${m}√ó</div>`;
      t.onclick=()=>{
        state.multiplier=m;
        localStorage.setItem("multiplier",m);
        renderSettings();
        renderChips();
      };
      multGrid.appendChild(t);
    });
  } else {
    multSection.style.display="none";
  }

  // THEME
  themeGrid.innerHTML="";
  THEMES.forEach(th=>{
    const t=document.createElement("div");
    t.className="tile"+(th===state.theme?" active":"");
    t.innerHTML=`<div class="name">${th}</div>`;
    t.onclick=()=>{
      state.theme=th;
      localStorage.setItem("theme",th);
      document.body.dataset.theme=th;
      renderSettings();
      renderChips();
    };
    themeGrid.appendChild(t);
  });
}

function renderChips(){
  chipGame.textContent = state.game;
  chipPay.textContent = state.paytable;
  chipTheme.textContent = state.theme;
  if(state.game==="ux"){
    chipMult.style.display="";
    chipMultVal.textContent = state.multiplier + "√ó";
  } else {
    chipMult.style.display="none";
  }
}
</script>
</body>
</html>
