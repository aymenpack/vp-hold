<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate X Wizard</title>

<style>
body { margin:0; font-family:system-ui; background:#020617; color:#fff; }
.app { max-width:900px; margin:auto; padding:16px 16px 120px; }
video { width:100%; max-height:320px; border-radius:16px; background:#000; }
.band { position:absolute; left:0; right:0; border-top:2px dashed #22c55e; border-bottom:2px dashed #22c55e; }
.row { display:flex; gap:10px; margin-top:12px; }
input,button { padding:12px; font-size:16px; border-radius:10px; border:none; }
input { background:#020617; color:#fff; border:1px solid #333; flex:1; }
button { background:#22c55e; color:#000; font-weight:bold; cursor:pointer; }
.card { display:inline-block; width:18%; margin:1%; padding:14px; border:1px solid #333; text-align:center; }
.hold { outline:3px solid #22c55e; transform:translateY(-6px); }
#error { color:#f87171; margin-top:10px; }
</style>
</head>

<body>
<div class="app">
  <h2>Ultimate X Wizard</h2>
  <p>Triple Play · 6/5 Bonus Poker</p>

  <div style="position:relative">
    <video id="video" autoplay playsinline muted></video>
    <div class="band" id="band"></div>
  </div>

  <div class="row">
    <input id="m1" value="1" placeholder="Hand 1 mult">
    <input id="m2" value="1" placeholder="Hand 2 mult">
    <input id="m3" value="1" placeholder="Hand 3 mult">
  </div>

  <div class="row">
    <button id="snap">SNAP</button>
  </div>

  <div id="error"></div>
  <div id="cards"></div>
  <div id="info"></div>
</div>

<script>
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";
const video = document.getElementById("video");
navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }})
  .then(s => video.srcObject = s);

function capture() {
  const vw = video.videoWidth, vh = video.videoHeight;
  const bandH = Math.floor(vh * 0.3);
  const top = Math.floor(vh * 0.5 - bandH / 2);

  const c = document.createElement("canvas");
  c.width = vw;
  c.height = bandH;
  c.getContext("2d").drawImage(video, 0, top, vw, bandH, 0, 0, vw, bandH);

  const out = document.createElement("canvas");
  out.width = 360;
  out.height = Math.floor(bandH * (360 / vw));
  out.getContext("2d").drawImage(c, 0, 0, out.width, out.height);

  return out.toDataURL("image/jpeg", 0.5);
}

snap.onclick = async () => {
  error.textContent = "";
  cards.innerHTML = "";
  info.textContent = "";

  try {
    const img = capture();
    const res = await fetch(WORKER_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        imageBase64: img,
        multipliers_fallback:[m1.value,m2.value,m3.value],
        progressive:false
      })
    });

    const data = await res.json();
    if (data.error) throw new Error(data.error);

    data.cards.forEach((c,i)=>{
      const d=document.createElement("div");
      d.className="card"+(data.hold[i]?" hold":"");
      d.textContent=c.rank+c.suit;
      cards.appendChild(d);
    });

    info.textContent = `Total ${data.multiplier_total}× | EV ${data.ev_total.toFixed(2)}`;

  } catch(e) {
    error.textContent = "Scan failed. Try again.";
  }
};
</script>
</body>
</html>
