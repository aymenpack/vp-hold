<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>VP Assistant</title>

<style>
/* ========== THEMES ========== */
body[data-theme="casino"]{
  --bg:#07140e; --panel:#10261b; --border:#1e3a2a;
  --text:#e9f6ef; --muted:#9fc7b2;
  --accent:#1aff8c; --hold:#22c55e;
}
body[data-theme="dark"]{
  --bg:#0b0f14; --panel:#121a24; --border:#223043;
  --text:#e9eef6; --muted:#b7c3d7;
  --accent:#2f6bff; --hold:#3b82f6;
}
body[data-theme="neon"]{
  --bg:#0b0020; --panel:#1a0033; --border:#3f007d;
  --text:#f3e8ff; --muted:#c4b5fd;
  --accent:#d946ef; --hold:#22ffcc;
}
body[data-theme="bright"]{
  --bg:#f4f6f8; --panel:#ffffff; --border:#d0d7de;
  --text:#111827; --muted:#4b5563;
  --accent:#2563eb; --hold:#16a34a;
}

/* ========== BASE ========== */
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,system-ui;
}
.app{max-width:900px;margin:auto;padding:12px 12px 160px}
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:12px;
  margin-bottom:12px;
}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
h2{margin:0;font-size:13px;color:var(--muted)}
button{
  background:transparent;color:var(--text);
  border:1px solid var(--border);
  border-radius:999px;
  padding:8px 14px;
}
button.primary{border-color:var(--accent)}
.small{font-size:12px;color:var(--muted)}

/* ========== SCANNER ========== */
.scanWrap{
  position:relative;height:140px;border-radius:12px;
  overflow:hidden;border:1px solid var(--border);
  user-select:none;touch-action:manipulation;
}
.scanWrap video{
  position:absolute;width:100%;top:50%;
  transform:translateY(-50%);
}
.scanGuide{
  position:absolute;inset:0;
  border-top:2px dashed rgba(255,255,255,.25);
  border-bottom:2px dashed rgba(255,255,255,.25);
}
.scanLabel{
  position:absolute;bottom:6px;left:50%;
  transform:translateX(-50%);
  font-size:11px;background:rgba(0,0,0,.5);
  padding:3px 10px;border-radius:999px;
}

/* ========== HAND ========== */
.hand{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.card{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px 6px;
  text-align:center;
  position:relative;
}
.card.hold{
  outline:3px solid var(--hold);
  box-shadow:0 0 18px var(--hold);
  transform:translateY(-4px);
}
.card.red{color:#ef4444}
.card.black{color:var(--text)}
.rank{font-size:22px;font-weight:800}
.suit{font-size:18px}
.badge{
  position:absolute;top:6px;right:6px;
  background:var(--hold);color:#000;
  font-size:10px;font-weight:900;padding:2px 6px;border-radius:999px;
}

/* ========== SNAP BUTTON ========== */
.snapBtn{
  position:fixed;bottom:70px;left:50%;
  transform:translateX(-50%);
  width:78px;height:78px;border-radius:50%;
  border:3px solid var(--accent);
  background:radial-gradient(circle,#fff,#e5e7eb);
}

/* ========== SETTINGS SHEET ========== */
.sheetBack{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:flex-end;justify-content:center;
}
.sheet{
  width:min(900px,100%);
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:18px;
  padding:12px;
}
.section{margin-bottom:14px}
.section h3{margin:0 0 6px;font-size:13px;color:var(--muted)}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
.tile{
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
  text-align:left;
}
.tile.active{
  border-color:var(--accent);
  box-shadow:0 0 0 4px color-mix(in srgb,var(--accent) 20%,transparent);
}
</style>
</head>

<body data-theme="casino">
<div class="app">

<!-- HEADER -->
<div class="panel hrow">
  <h2>VP Assistant</h2>
  <button id="openSettings">⚙️ Settings</button>
</div>

<!-- SCANNER -->
<div class="panel">
  <h2>Scan cards</h2>
  <div class="scanWrap" id="scanWrap">
    <video id="video" playsinline autoplay muted></video>
    <div class="scanGuide"></div>
    <div class="scanLabel">Align card row here • Tap to snap</div>
  </div>
  <div class="small" id="status">Camera ready</div>
</div>

<!-- HAND -->
<div class="panel">
  <div class="hand" id="hand"></div>
</div>

</div>

<button class="snapBtn" id="snapBtn"></button>
<canvas id="canvas" style="display:none"></canvas>

<!-- SETTINGS -->
<div class="sheetBack" id="sheetBack">
  <div class="sheet">
    <div class="hrow">
      <h2>Settings</h2>
      <button id="closeSettings">Close</button>
    </div>

    <!-- GAME -->
    <div class="section">
      <h3>Game</h3>
      <div class="grid" id="gameGrid"></div>
    </div>

    <!-- PAYTABLE -->
    <div class="section">
      <h3>Paytable</h3>
      <div class="grid" id="paytableGrid"></div>
    </div>

    <!-- THEME -->
    <div class="section">
      <h3>Theme</h3>
      <div class="grid" id="themeGrid"></div>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";
const SUIT={S:"♠",H:"♥",D:"♦",C:"♣"};

const GAMES=[
  {k:"job",n:"Jacks"},
  {k:"bonus",n:"Bonus"},
  {k:"double_bonus",n:"Double Bonus"},
  {k:"ddb",n:"DDB"},
  {k:"deuces",n:"Deuces"},
  {k:"ux",n:"Ultimate X"}
];

const PAYTABLES={
  job:["9/6","8/5"],
  bonus:["standard"],
  double_bonus:["standard"],
  ddb:["standard"],
  deuces:["standard"],
  ux:["standard"]
};

const THEMES=["casino","dark","neon","bright"];

/* ===== STATE ===== */
let currentGame=localStorage.getItem("game")||"job";
let currentPaytable=localStorage.getItem("paytable")||"standard";
let currentTheme=localStorage.getItem("theme")||"casino";
let cards=[],hold=[],cameraStream=null;

/* ===== ELEMENTS ===== */
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const handDiv=document.getElementById("hand");
const statusEl=document.getElementById("status");

/* ===== INIT ===== */
document.body.dataset.theme=currentTheme;

/* CAMERA */
async function startCamera(){
  if(cameraStream) return;
  cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=cameraStream;
}
function stopCamera(){
  if(!cameraStream) return;
  cameraStream.getTracks().forEach(t=>t.stop());
  cameraStream=null;
}
startCamera();
document.addEventListener("visibilitychange",()=>document.hidden?stopCamera():startCamera());

/* SNAP */
async function snap(){
  const vw=video.videoWidth,vh=video.videoHeight;
  if(!vw) return;

  const bandH=vh*0.35,bandY=(vh-bandH)/2;
  canvas.width=vw;canvas.height=bandH;
  canvas.getContext("2d").drawImage(video,0,bandY,vw,bandH,0,0,vw,bandH);

  const img=canvas.toDataURL("image/jpeg",0.7);

  const res=await fetch(WORKER_URL,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      imageBase64:img,
      game:currentGame,
      paytable:currentPaytable
    })
  });

  const d=await res.json();
  cards=d.cards||[];
  hold=d.hold||[];
  renderHand();
}
document.getElementById("snapBtn").onclick=snap;
document.getElementById("scanWrap").onclick=snap;

/* RENDER HAND */
function renderHand(){
  handDiv.innerHTML="";
  cards.forEach((c,i)=>{
    const red=(c.suit==="H"||c.suit==="D");
    const d=document.createElement("div");
    d.className=`card ${hold[i]?"hold":""} ${red?"red":"black"}`;
    d.innerHTML=`
      ${hold[i]?'<div class="badge">HOLD</div>':''}
      <div class="rank">${c.rank}</div>
      <div class="suit">${SUIT[c.suit]}</div>`;
    handDiv.appendChild(d);
  });
}

/* SETTINGS UI */
const sheetBack=document.getElementById("sheetBack");
document.getElementById("openSettings").onclick=()=>sheetBack.style.display="flex";
document.getElementById("closeSettings").onclick=()=>sheetBack.style.display="none";

function renderSettings(){
  const gameGrid=document.getElementById("gameGrid");
  const payGrid=document.getElementById("paytableGrid");
  const themeGrid=document.getElementById("themeGrid");

  gameGrid.innerHTML="";
  GAMES.forEach(g=>{
    const b=document.createElement("div");
    b.className="tile"+(g.k===currentGame?" active":"");
    b.textContent=g.n;
    b.onclick=()=>{
      currentGame=g.k;
      localStorage.setItem("game",g.k);
      currentPaytable=PAYTABLES[g.k][0];
      localStorage.setItem("paytable",currentPaytable);
      renderSettings();
    };
    gameGrid.appendChild(b);
  });

  payGrid.innerHTML="";
  PAYTABLES[currentGame].forEach(p=>{
    const b=document.createElement("div");
    b.className="tile"+(p===currentPaytable?" active":"");
    b.textContent=p;
    b.onclick=()=>{
      currentPaytable=p;
      localStorage.setItem("paytable",p);
      renderSettings();
    };
    payGrid.appendChild(b);
  });

  themeGrid.innerHTML="";
  THEMES.forEach(t=>{
    const b=document.createElement("div");
    b.className="tile"+(t===currentTheme?" active":"");
    b.textContent=t;
    b.onclick=()=>{
      currentTheme=t;
      document.body.dataset.theme=t;
      localStorage.setItem("theme",t);
      renderSettings();
    };
    themeGrid.appendChild(b);
  });
}
renderSettings();
</script>
</body>
</html>
