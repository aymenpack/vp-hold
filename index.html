<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate X – Vision Debug</title>

<!-- LOCKED CAMERA + FRAME STYLES -->
<link rel="stylesheet" href="./capture/camera.css">

<style>
body{
  margin:0;
  background:#020617;
  color:#fff;
  font-family:system-ui;
}
.app{
  max-width:900px;
  margin:auto;
  padding:16px 16px 160px;
}
h2{margin:0}
.subtitle{
  font-size:14px;
  color:#9ca3af;
  margin-bottom:12px;
}

button{
  margin-top:18px;
  width:100%;
  padding:18px;
  font-size:20px;
  font-weight:900;
  background:#22c55e;
  color:#000;
  border:none;
  border-radius:18px;
  cursor:pointer;
}

#preview{
  margin-top:16px;
  width:100%;
  border-radius:14px;
  border:1px solid #333;
}

/* DEBUG PANEL */
#visionDebug{
  margin-top:14px;
  padding:12px;
  border-radius:12px;
  background:#020617;
  border:1px solid #333;
  color:#9ca3af;
  font-size:12px;
  max-height:240px;
  overflow:auto;
  white-space:pre-wrap;
}

#status{
  margin-top:10px;
  font-size:14px;
  color:#9ca3af;
}
</style>
</head>

<body>
<div class="app">
  <h2>Ultimate X – Vision Debug</h2>
  <div class="subtitle">
    Camera & capture are locked. This page only debugs Vision.
  </div>

  <!-- CAMERA (LOCKED) -->
  <div class="scanner" id="scanner">
    <video id="video" autoplay playsinline muted></video>
    <div class="band" id="band"></div>
  </div>

  <button id="snap">SNAP → Vision</button>

  <img id="preview" alt="Captured preview">

  <pre id="visionDebug"></pre>

  <div id="status">Starting camera…</div>
</div>

<script type="module">
/* ===============================
   IMPORT LOCKED CAPTURE SYSTEM
   =============================== */
import {
  positionGreenFrame,
  captureFromGreenFrame
} from "./capture/capture.js";

/* ===============================
   CONFIG
   =============================== */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

/* ===============================
   ELEMENTS
   =============================== */
const video   = document.getElementById("video");
const band    = document.getElementById("band");
const scanner = document.getElementById("scanner");
const snap    = document.getElementById("snap");
const preview = document.getElementById("preview");
const debug   = document.getElementById("visionDebug");
const statusEl = document.getElementById("status");

/* ===============================
   START CAMERA (LOCKED)
   =============================== */
navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }})
.then(stream=>{
  video.srcObject = stream;
  statusEl.textContent = "Camera ready — align machine";
  requestAnimationFrame(() => positionGreenFrame(scanner, band));
})
.catch(err=>{
  statusEl.textContent = "Camera error: " + err.message;
});

/* ===============================
   SNAP → CAPTURE → VISION
   =============================== */
snap.onclick = async () => {
  statusEl.textContent = "Capturing…";
  debug.textContent = "";

  try {
    /* 1️⃣ Capture image (LOCKED capture) */
    const img = await captureFromGreenFrame({
      video,
      band,
      scanner
    });

    preview.src = img;
    statusEl.textContent = "Sending to Vision…";

    /* 2️⃣ Call worker */
    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ imageBase64: img })
    });

    const rawText = await res.text();

    /* 3️⃣ Show FULL response */
    debug.textContent =
      `HTTP ${res.status}\n\n${rawText}`;

    /* 4️⃣ Attempt JSON parse (for visibility only) */
    try {
      JSON.parse(rawText);
      statusEl.textContent = "Vision response received";
    } catch {
      statusEl.textContent = "Vision returned non-JSON";
    }

  } catch (err) {
    statusEl.textContent = "Client error";
    debug.textContent =
      "CLIENT ERROR:\n" + err.message;
  }
};
</script>
</body>
</html>
