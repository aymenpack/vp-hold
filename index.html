<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Ultimate X Assistant</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>
/* (styles unchanged â€” omitted for brevity, same as before) */
</style>
</head>

<body>
<div class="app">
<header>
  <h1>Ultimate X Assistant</h1>
  <div class="subtitle">LLM Vision Â· Bottom row capture</div>
</header>

<div class="scanner">
  <video id="video" autoplay playsinline muted></video>
  <div class="band" id="band"></div>
</div>

<div class="status" id="status">Align bottom row between green lines</div>
<div id="error"></div>

<div id="previewWrap">
  <img id="previewImg">
</div>

<div id="hand"></div>

<footer>
  <button id="snap" class="primary">SNAP</button>
</footer>

<script>
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

// ðŸ”‘ FINAL CAPTURE PROFILE (FIXED)
const PROFILE = {
  bandTopFrac: 0.58,  // ðŸ‘ˆ anchor lower for bottom row
  bandFrac:    0.35,
  outW:        900,
  jpegQ:       0.8
};

const video = document.getElementById("video");
const band  = document.getElementById("band");
const snap  = document.getElementById("snap");
const previewImg = document.getElementById("previewImg");
const statusEl = document.getElementById("status");
const errorEl  = document.getElementById("error");

navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }})
.then(stream=>{
  video.srcObject = stream;
  statusEl.textContent = "Align bottom row between green lines";
  requestAnimationFrame(updateBand);
});

function updateBand(){
  const r = video.getBoundingClientRect();
  const h = r.height * PROFILE.bandFrac;
  band.style.top = (r.height * PROFILE.bandTopFrac) + "px";
  band.style.height = h + "px";
  requestAnimationFrame(updateBand);
}

async function capture(){
  await new Promise(r=>requestAnimationFrame(r));
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  if(!vw||!vh) throw new Error("Camera not ready");

  const bandH = Math.floor(vh * PROFILE.bandFrac);
  const bandY = Math.floor(vh * PROFILE.bandTopFrac);

  const raw = document.createElement("canvas");
  raw.width = vw;
  raw.height = bandH;
  raw.getContext("2d").drawImage(
    video,
    0, bandY, vw, bandH,
    0, 0, vw, bandH
  );

  const out = document.createElement("canvas");
  out.width = PROFILE.outW;
  out.height = Math.floor(bandH * (PROFILE.outW / vw));
  out.getContext("2d").drawImage(raw, 0, 0, out.width, out.height);

  return out.toDataURL("image/jpeg", PROFILE.jpegQ);
}

snap.onclick = async()=>{
  errorEl.style.display="none";
  statusEl.textContent="Capturingâ€¦";

  try{
    const img = await capture();
    previewImg.src = img;

    statusEl.textContent="Sending to visionâ€¦";

    const res = await fetch(WORKER_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ imageBase64: img })
    });

    const data = await res.json();
    if(data.error) throw new Error(data.error);

    statusEl.textContent="Done";

  }catch(e){
    errorEl.style.display="block";
    errorEl.textContent=e.message;
    statusEl.textContent="Error";
  }
};
</script>
</body>
</html>
