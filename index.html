<script type="module">
import {
  positionGreenFrame,
  captureBitmapFromGreenFrame
} from "./capture/capture.js";

const WORKER_URL =
  "https://vp-hold-production.up.railway.app/analyze";

/* DOM */
const video = document.getElementById("video");
const band = document.getElementById("band");
const scanner = document.getElementById("scanner");
const snapBtn = document.getElementById("snap");
const modeSelect = document.getElementById("modeSelect");
const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");

const multTop = document.getElementById("multTop");
const multMid = document.getElementById("multMid");
const multBot = document.getElementById("multBot");
const evBaseEl = document.getElementById("evBase");
const evUXEl = document.getElementById("evUX");
const cardsBox = document.getElementById("cardsBox");
const whyText = document.getElementById("whyText");

let busy = false;

/* Camera */
(async () => {
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" }
  });
  video.srcObject = stream;
  await video.play();
  statusEl.textContent = "Camera ready";
  requestAnimationFrame(() => positionGreenFrame(scanner, band));
})();

/* Render helpers */
function renderMultipliers(m) {
  multTop.textContent = "Ã—" + m.top;
  multMid.textContent = "Ã—" + m.middle;
  multBot.textContent = "Ã—" + m.bottom;
}
function renderEVs(evBase, evUX) {
  evBaseEl.textContent = evBase.toFixed(4);
  evUXEl.textContent = evUX.toFixed(4);
}
function renderCards(cards, bestHold) {
  cardsBox.innerHTML = "";
  const SUIT = { S:"â™ ", H:"â™¥", D:"â™¦", C:"â™£" };
  cards.forEach((c,i)=>{
    const el=document.createElement("div");
    el.className="card";
    if(bestHold[i]) el.classList.add("held");
    if(c.suit==="H"||c.suit==="D") el.classList.add("red");
    el.innerHTML =
      `<div class="rank">${c.rank}</div>
       <div class="suit">${SUIT[c.suit]}</div>`;
    cardsBox.appendChild(el);
  });
}
function explainHold(multiplier, mode){
  whyText.textContent =
    mode==="aggressive"
      ? "Aggressive mode prioritizes multiplier growth."
      : "Maximizing expected value with lower variance.";
}

/* SNAP */
snapBtn.onclick = async () => {
  if (busy) return;
  busy = true;
  snapBtn.disabled = true;
  statusEl.textContent = "Processingâ€¦";

  try {
    const bitmap = await captureBitmapFromGreenFrame({
      video, band, scanner
    });

    const worker = new Worker("./ui/snapWorker.js", { type: "module" });

    worker.onmessage = (e) => {
      try {
        const { ok, data, error } = e.data;

        if (!ok) {
          statusEl.textContent = "Worker error";
          debugEl.textContent = error;
          return;
        }

        renderMultipliers(data.multipliers);
        renderEVs(
          data.ev_without_multiplier,
          data.ev_with_multiplier
        );
        renderCards(data.cards, data.best_hold);
        explainHold(data.multipliers.bottom, data.mode);

        debugEl.textContent = JSON.stringify(data, null, 2);
        statusEl.textContent = "Done âœ…";
      } finally {
        // ðŸ”‘ ALWAYS UNLOCK UI
        busy = false;
        snapBtn.disabled = false;
        worker.terminate();
      }
    };

    worker.postMessage({
      bitmap,
      workerUrl: WORKER_URL,
      paytable: "DDB_9_6",
      mode: modeSelect.value
    }, [bitmap]);

  } catch (err) {
    statusEl.textContent = "Client error";
    debugEl.textContent = err.message || String(err);
    busy = false;
    snapBtn.disabled = false;
  }
};
</script>
