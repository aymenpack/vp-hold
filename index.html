<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>VP Assistant</title>

<style>
/* ================= THEME TOKENS ================= */
body[data-theme="casino"]{
  --bg:#07140e; --panel:#10261b; --border:#1e3a2a;
  --text:#e9f6ef; --muted:#9fc7b2;
  --accent:#1aff8c; --hold:#22c55e;
}
body[data-theme="dark"]{
  --bg:#0b0f14; --panel:#121a24; --border:#223043;
  --text:#e9eef6; --muted:#b7c3d7;
  --accent:#2f6bff; --hold:#3b82f6;
}
body[data-theme="neon"]{
  --bg:#0b0020; --panel:#1a0033; --border:#3f007d;
  --text:#f3e8ff; --muted:#c4b5fd;
  --accent:#d946ef; --hold:#22ffcc;
}
body[data-theme="bright"]{
  --bg:#f4f6f8; --panel:#ffffff; --border:#d0d7de;
  --text:#111827; --muted:#4b5563;
  --accent:#2563eb; --hold:#16a34a;
}

/* ================= BASE ================= */
*{box-sizing:border-box}
body{
  margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,system-ui;
}
.app{max-width:900px;margin:auto;padding:12px 12px 160px}
.panel{
  background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:12px;margin-bottom:12px;
}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:10px}
h2{margin:0;font-size:13px;color:var(--muted)}
button{
  background:transparent;color:var(--text);
  border:1px solid var(--border);
  border-radius:999px;padding:8px 14px;
}
button.primary{border-color:var(--accent)}
.small{font-size:12px;color:var(--muted)}

/* ================= GAME BAR ================= */
.gameBar{display:flex;gap:8px;overflow-x:auto}
.gameBtn{white-space:nowrap}
.gameBtn.active{
  border-color:var(--accent);
  box-shadow:0 0 0 4px color-mix(in srgb,var(--accent) 20%,transparent);
}

/* ================= SCANNER ================= */
.scanWrap{
  position:relative;height:140px;border-radius:12px;
  overflow:hidden;border:1px solid var(--border);
}
.scanWrap video{
  position:absolute;width:100%;top:50%;
  transform:translateY(-50%);
}
.scanGuide{
  position:absolute;inset:0;
  border-top:2px dashed rgba(255,255,255,.25);
  border-bottom:2px dashed rgba(255,255,255,.25);
}
.scanLabel{
  position:absolute;bottom:6px;left:50%;
  transform:translateX(-50%);
  font-size:11px;background:rgba(0,0,0,.5);
  padding:3px 10px;border-radius:999px;
}

/* ================= HAND ================= */
.hand{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.card{
  border:1px solid var(--border);border-radius:14px;
  padding:12px 6px;text-align:center;position:relative;
}
.card.hold{
  outline:3px solid var(--hold);
  box-shadow:0 0 18px var(--hold);
  transform:translateY(-4px);
}
.card.red{color:#ef4444}
.card.black{color:var(--text)}
.rank{font-size:22px;font-weight:800}
.suit{font-size:18px}
.badge{
  position:absolute;top:6px;right:6px;
  background:var(--hold);color:#000;
  font-size:10px;font-weight:900;padding:2px 6px;border-radius:999px;
}

/* ================= SNAP ================= */
.snapBtn{
  position:fixed;bottom:70px;left:50%;
  transform:translateX(-50%);
  width:78px;height:78px;border-radius:50%;
  border:3px solid var(--accent);
  background:radial-gradient(circle,#fff,#e5e7eb);
}

/* ================= HISTORY ================= */
.historyItem{
  border:1px solid var(--border);
  border-radius:12px;
  padding:8px;
  margin-bottom:6px;
}
.historyRow{display:flex;gap:6px;font-size:12px}

/* ================= SETTINGS ================= */
.sheetBack{
  position:fixed;inset:0;background:rgba(0,0,0,.55);
  display:none;align-items:flex-end;justify-content:center;
}
.sheet{
  width:min(900px,100%);
  background:var(--panel);border:1px solid var(--border);
  border-radius:18px;padding:12px;
}
.tileGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.tile{
  border:1px solid var(--border);border-radius:14px;
  padding:12px;text-align:left;
}
.tile.active{border-color:var(--accent)}
</style>
</head>

<body data-theme="casino">
<div class="app">

<!-- HEADER -->
<div class="panel hrow">
  <h2>VP Assistant</h2>
  <button id="openSettings">⚙️ Settings</button>
</div>

<!-- GAME -->
<div class="panel">
  <div class="gameBar" id="gameBar"></div>
</div>

<!-- SCANNER -->
<div class="panel">
  <h2>Scan cards</h2>
  <div class="scanWrap" id="scanWrap">
    <video id="video" playsinline autoplay muted></video>
    <div class="scanGuide"></div>
    <div class="scanLabel">Align card row here • Tap to snap</div>
  </div>
  <div class="small" id="status">Camera ready</div>
</div>

<!-- HAND -->
<div class="panel">
  <div class="hand" id="hand"></div>
</div>

<!-- HISTORY -->
<div class="panel">
  <h2>History</h2>
  <div id="history"></div>
  <div class="small" id="stats"></div>
</div>

</div>

<button class="snapBtn" id="snapBtn"></button>
<canvas id="canvas" style="display:none"></canvas>

<!-- SETTINGS -->
<div class="sheetBack" id="sheetBack">
  <div class="sheet">
    <div class="hrow">
      <h2>Settings</h2>
      <button id="closeSettings">Close</button>
    </div>

    <h2>Game</h2>
    <div class="tileGrid" id="gameTiles"></div>

    <h2>Theme</h2>
    <div class="tileGrid" id="themeTiles"></div>

    <button id="stopCam">Stop Camera</button>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

/* ================= DATA ================= */
const SUIT={S:"♠",H:"♥",D:"♦",C:"♣"};
const GAMES=[
  {k:"job",n:"Jacks"},
  {k:"bonus",n:"Bonus"},
  {k:"double_bonus",n:"Double Bonus"},
  {k:"ddb",n:"DDB"},
  {k:"deuces",n:"Deuces"},
  {k:"ux",n:"Ultimate X"}
];
const THEMES=["casino","dark","neon","bright"];

/* ================= STATE ================= */
let currentGame=localStorage.getItem("game")||"job";
let currentTheme=localStorage.getItem("theme")||"casino";
let cards=[],hold=[];
let history=[];
let cameraStream=null;

/* ================= ELEMENTS ================= */
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const handDiv=document.getElementById("hand");
const historyDiv=document.getElementById("history");
const statsDiv=document.getElementById("stats");

/* ================= INIT ================= */
document.body.dataset.theme=currentTheme;

/* GAME BAR */
const gameBar=document.getElementById("gameBar");
GAMES.forEach(g=>{
  const b=document.createElement("button");
  b.className="gameBtn"+(g.k===currentGame?" active":"");
  b.textContent=g.n;
  b.onclick=()=>{currentGame=g.k;localStorage.setItem("game",g.k);renderGameBar();};
  gameBar.appendChild(b);
});
function renderGameBar(){
  [...gameBar.children].forEach(b=>b.classList.toggle("active",b.textContent===GAMES.find(x=>x.k===currentGame).n));
}
renderGameBar();

/* CAMERA */
async function startCamera(){
  if(cameraStream) return;
  cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=cameraStream;
}
function stopCamera(){
  if(!cameraStream) return;
  cameraStream.getTracks().forEach(t=>t.stop());
  cameraStream=null;
}
startCamera();
document.addEventListener("visibilitychange",()=>document.hidden?stopCamera():startCamera());

/* SNAP */
document.getElementById("snapBtn").onclick=async()=>{
  const vw=video.videoWidth,vh=video.videoHeight;
  if(!vw) return;

  const bandH=vh*0.35,bandY=(vh-bandH)/2;
  canvas.width=vw;canvas.height=bandH;
  canvas.getContext("2d").drawImage(video,0,bandY,vw,bandH,0,0,vw,bandH);

  const img=canvas.toDataURL("image/jpeg",0.7);

  const res=await fetch(WORKER_URL,{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify({imageBase64:img,game:currentGame,paytable:"standard"})
  });

  const d=await res.json();
  cards=d.cards||[];
  hold=d.hold||[];

  history.unshift({cards,hold,game:currentGame});
  history=history.slice(0,10);

  renderHand();
  renderHistory();
};

/* RENDER */
function renderHand(){
  handDiv.innerHTML="";
  cards.forEach((c,i)=>{
    const red=(c.suit==="H"||c.suit==="D");
    const d=document.createElement("div");
    d.className=`card ${hold[i]?"hold":""} ${red?"red":"black"}`;
    d.innerHTML=`
      ${hold[i]?'<div class="badge">HOLD</div>':''}
      <div class="rank">${c.rank}</div>
      <div class="suit">${SUIT[c.suit]}</div>`;
    handDiv.appendChild(d);
  });
}
function renderHistory(){
  historyDiv.innerHTML="";
  history.forEach(h=>{
    const div=document.createElement("div");
    div.className="historyItem";
    div.innerHTML=`<div class="historyRow">${h.game.toUpperCase()} — ${h.cards.map(c=>c.rank+c.suit).join(" ")}</div>`;
    historyDiv.appendChild(div);
  });
  statsDiv.textContent=`Hands scanned: ${history.length}`;
}

/* SETTINGS */
const sheetBack=document.getElementById("sheetBack");
document.getElementById("openSettings").onclick=()=>sheetBack.style.display="flex";
document.getElementById("closeSettings").onclick=()=>sheetBack.style.display="none";
document.getElementById("stopCam").onclick=stopCamera;
</script>
</body>
</html>
