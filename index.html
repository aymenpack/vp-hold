<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate X Wizard</title>

<style>
body{
  margin:0;
  font-family:system-ui;
  background:#020617;
  color:#fff;
}
.app{
  max-width:900px;
  margin:auto;
  padding:16px 16px 120px;
}
h2{margin:0}
.subtitle{font-size:13px;color:#9ca3af;margin-bottom:10px}

.videoWrap{
  position:relative;
  margin-top:14px;
}
video{
  width:100%;
  max-height:320px;
  border-radius:16px;
  background:#000;
  border:1px solid #1f2937;
}

/* FIXED GUIDE LINES */
.band{
  position:absolute;
  left:0;
  right:0;
  border-top:2px dashed #22c55e;
  border-bottom:2px dashed #22c55e;
  pointer-events:none;
}

.row{
  display:flex;
  gap:10px;
  margin-top:12px;
  flex-wrap:wrap;
}
input,button{
  padding:12px;
  font-size:16px;
  border-radius:10px;
  border:none;
}
input{
  background:#020617;
  color:#fff;
  border:1px solid #333;
  flex:1;
  min-width:90px;
}
button{
  background:#22c55e;
  color:#000;
  font-weight:bold;
  cursor:pointer;
}
button:disabled{opacity:.5}

#cards{margin-top:16px}
.card{
  display:inline-block;
  width:18%;
  margin:1%;
  padding:14px;
  border:1px solid #333;
  border-radius:10px;
  text-align:center;
}
.hold{
  outline:3px solid #22c55e;
  transform:translateY(-6px);
}

#error{
  margin-top:10px;
  color:#f87171;
  white-space:pre-wrap;
}

#info{
  margin-top:10px;
  font-size:14px;
  color:#e5e7eb;
}
</style>
</head>

<body>
<div class="app">
  <h2>Ultimate X Wizard</h2>
  <div class="subtitle">
    Place the 5 cards between the green lines · Triple Play · 6/5 Bonus Poker
  </div>

  <div class="videoWrap">
    <video id="video" autoplay playsinline muted></video>
    <div class="band" id="band"></div>
  </div>

  <div class="row">
    <input id="m1" value="1" placeholder="Hand 1 mult">
    <input id="m2" value="1" placeholder="Hand 2 mult">
    <input id="m3" value="1" placeholder="Hand 3 mult">
  </div>

  <div class="row">
    <button id="snap">SNAP</button>
  </div>

  <div id="error"></div>
  <div id="cards"></div>
  <div id="info"></div>
</div>

<script>
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

/* ===== FIXED CROP CONSTANTS (LOCKED) ===== */
const BAND_CENTER = 0.50;
const BAND_HEIGHT = 0.38;
const LEFT_CROP   = 0.05;
const RIGHT_CROP  = 0.00;
const OUT_WIDTH   = 480;
const JPEG_Q      = 0.60;

const video = document.getElementById("video");
const band  = document.getElementById("band");

navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }})
  .then(s => video.srcObject = s)
  .catch(()=> error.textContent="Camera permission denied");

function updateBand(){
  const r = video.getBoundingClientRect();
  const h = r.height * BAND_HEIGHT;
  const top = r.height * BAND_CENTER - h/2;
  band.style.top = top+"px";
  band.style.height = h+"px";
  requestAnimationFrame(updateBand);
}
requestAnimationFrame(updateBand);

function capture(){
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  if(!vw || !vh) return null;

  const bandH = Math.floor(vh * BAND_HEIGHT);
  const top   = Math.floor(vh * BAND_CENTER - bandH/2);

  const left  = Math.floor(vw * LEFT_CROP);
  const right = Math.floor(vw * RIGHT_CROP);
  const cw    = vw - left - right;

  const crop = document.createElement("canvas");
  crop.width = cw;
  crop.height = bandH;
  crop.getContext("2d").drawImage(
    video,
    left, top, cw, bandH,
    0, 0, cw, bandH
  );

  const out = document.createElement("canvas");
  out.width = OUT_WIDTH;
  out.height = Math.max(1, Math.floor(bandH * (OUT_WIDTH / cw)));
  out.getContext("2d").drawImage(crop, 0, 0, out.width, out.height);

  return out.toDataURL("image/jpeg", JPEG_Q);
}

snap.onclick = async()=>{
  error.textContent="";
  cards.innerHTML="";
  info.textContent="";
  snap.disabled=true;

  try{
    const img = capture();
    if(!img) throw new Error("Camera not ready");

    const res = await fetch(WORKER_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        imageBase64: img,
        multipliers_fallback:[m1.value,m2.value,m3.value],
        progressive:false
      })
    });

    const data = await res.json();
    if(data.error) throw new Error(data.error);

    data.cards.forEach((c,i)=>{
      const d=document.createElement("div");
      d.className="card"+(data.hold[i]?" hold":"");
      d.textContent=c.rank+c.suit;
      cards.appendChild(d);
    });

    info.textContent =
      `Total ${data.multiplier_total}× | EV ${data.ev_total.toFixed(2)} | Wizard Strategy`;

  }catch(e){
    error.textContent = "Scan failed: " + e.message;
  }finally{
    snap.disabled=false;
  }
};
</script>
</body>
</html>
