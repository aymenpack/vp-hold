<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate X – Vision UI</title>

<link rel="stylesheet" href="./capture/camera.css">

<style>
body{
  margin:0;
  background:#020617;
  color:#fff;
  font-family:system-ui;
}
.app{
  max-width:900px;
  margin:auto;
  padding:16px 16px 160px;
}
button{
  margin-top:18px;
  width:100%;
  padding:18px;
  font-size:20px;
  font-weight:900;
  background:#22c55e;
  color:#000;
  border:none;
  border-radius:18px;
  cursor:pointer;
}
button:disabled{opacity:.6}
#status{margin-top:12px;color:#9ca3af}
#debug{
  margin-top:12px;
  font-size:12px;
  white-space:pre-wrap;
  color:#9ca3af;
}
</style>
</head>

<body>
<div class="app">
  <h2>Ultimate X – Vision UI</h2>

  <div class="scanner" id="scanner">
    <video id="video" autoplay playsinline muted></video>
    <div class="band" id="band"></div>
  </div>

  <button id="snap">SNAP</button>

  <div id="status">Starting camera…</div>
  <pre id="debug"></pre>
</div>

<script type="module">
import { positionGreenFrame, captureFromGreenFrame } from "./capture/capture.js";

const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

const video = document.getElementById("video");
const band = document.getElementById("band");
const scanner = document.getElementById("scanner");
const snap = document.getElementById("snap");
const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");

let busy = false;

/* CAMERA */
navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }})
.then(stream=>{
  video.srcObject = stream;
  statusEl.textContent = "Camera ready";
  requestAnimationFrame(()=>positionGreenFrame(scanner, band));
});

/* SNAP */
snap.onclick = async ()=>{
  if (busy) return;
  busy = true;
  snap.disabled = true;

  try {
    statusEl.textContent = "Capturing…";

    // 1) Capture base64
    const dataUrl = await captureFromGreenFrame({ video, band, scanner });

    // 2) Convert base64 → Blob (CRITICAL FIX)
    const res = await fetch(dataUrl);
    const blob = await res.blob();

    // 3) Build FormData
    const form = new FormData();
    form.append("image", blob, "frame.jpg");
    form.append("paytable", "DDB_9_6");
    form.append("mode", "conservative");

    statusEl.textContent = "Sending to worker…";

    // 4) POST multipart/form-data
    const r = await fetch(
      WORKER_URL + "?req=" + crypto.randomUUID(),
      {
        method: "POST",
        body: form
      }
    );

    const text = await r.text();
    debugEl.textContent = text;

    if (!r.ok) {
      statusEl.textContent = "Worker error";
      return;
    }

    statusEl.textContent = "Done ✅";

  } catch (e) {
    statusEl.textContent = "Client error";
    debugEl.textContent = e.message || String(e);
  } finally {
    busy = false;
    snap.disabled = false;
  }
};
</script>
</body>
</html>
