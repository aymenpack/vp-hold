<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate X â€“ Vision UI</title>

<link rel="stylesheet" href="./capture/camera.css">

<style>
body{
  margin:0;
  background:#020617;
  color:#fff;
  font-family:system-ui;
}
.app{
  max-width:900px;
  margin:auto;
  padding:16px 16px 160px;
}
h2{margin:0}
.subtitle{font-size:14px;color:#9ca3af;margin-bottom:12px}

button{
  margin-top:18px;
  width:100%;
  padding:18px;
  font-size:20px;
  font-weight:900;
  background:#22c55e;
  color:#000;
  border:none;
  border-radius:18px;
  cursor:pointer;
}
button:disabled{opacity:.6;cursor:not-allowed}

#status{margin-top:10px;font-size:14px;color:#9ca3af}
#debug{
  margin-top:14px;
  padding:12px;
  border-radius:12px;
  border:1px solid #333;
  background:#020617;
  color:#9ca3af;
  font-size:12px;
  white-space:pre-wrap;
  max-height:260px;
  overflow:auto;
}
</style>
</head>

<body>
<div class="app">
  <h2>Ultimate X â€“ Vision UI</h2>
  <div class="subtitle">Camera + Worker pipeline</div>

  <div class="scanner" id="scanner">
    <video id="video" autoplay playsinline muted></video>
    <div class="band" id="band"></div>
  </div>

  <button id="snap">SNAP</button>

  <div id="status">Starting cameraâ€¦</div>
  <pre id="debug"></pre>
</div>

<script type="module">
import {
  positionGreenFrame,
  captureBitmapFromGreenFrame
} from "./capture/capture.js";

const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

const video = document.getElementById("video");
const band = document.getElementById("band");
const scanner = document.getElementById("scanner");
const snapBtn = document.getElementById("snap");
const statusEl = document.getElementById("status");
const debugEl = document.getElementById("debug");

let inflight = false;

/* ===============================
   CAMERA INIT (FIXED)
   =============================== */
(async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });

    video.srcObject = stream;

    // ðŸ”‘ REQUIRED â€” ensure playback actually starts
    await video.play();

    statusEl.textContent = "Camera ready â€” align machine";
    requestAnimationFrame(() => positionGreenFrame(scanner, band));
  } catch (err) {
    statusEl.textContent = "Camera error";
    debugEl.textContent = err?.message || String(err);
  }
})();

/* ===============================
   WEB WORKER
   =============================== */
const snapWorker = new Worker("./ui/snapWorker.js", { type: "module" });

snapWorker.onmessage = (evt) => {
  const { ok, data, raw } = evt.data;

  if (!ok || !data) {
    statusEl.textContent = "Worker error";
    debugEl.textContent = raw || "Unknown error";
  } else {
    statusEl.textContent = "Done âœ…";
    debugEl.textContent = JSON.stringify(data, null, 2);
  }

  inflight = false;
  snapBtn.disabled = false;
};

/* ===============================
   SNAP
   =============================== */
snapBtn.onclick = async () => {
  if (inflight) return;
  inflight = true;
  snapBtn.disabled = true;

  try {
    statusEl.textContent = "Capturingâ€¦";

    const bitmap = await captureBitmapFromGreenFrame({
      video,
      band,
      scanner
    });

    statusEl.textContent = "Processingâ€¦";

    snapWorker.postMessage({
      bitmap,
      workerUrl: WORKER_URL,
      paytable: "DDB_9_6",
      mode: "conservative",
      jpegQuality: 0.85
    }, [bitmap]);
  } catch (err) {
    inflight = false;
    snapBtn.disabled = false;
    statusEl.textContent = "Client error";
    debugEl.textContent = err?.message || String(err);
  }
};
</script>
</body>
</html>
