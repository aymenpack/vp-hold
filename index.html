<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ultimate X Triple Play</title>

<style>
body{margin:0;font-family:system-ui;background:#020617;color:#fff}
button,input{font-size:16px;padding:12px;border-radius:10px;border:none}
button{background:#22c55e;color:#000;font-weight:bold}
.card{display:inline-block;width:18%;margin:1%;padding:16px;border:1px solid #333;text-align:center}
.hold{border:3px solid #22c55e}
#history{position:fixed;bottom:0;left:0;right:0;background:#000;padding:10px;max-height:40%;overflow:auto}
</style>
</head>
<body>

<h2>Ultimate X Triple Play</h2>

<video id="video" autoplay playsinline width="100%"></video>

<p>
Multipliers:
<input id="m1" value="1">
<input id="m2" value="1">
<input id="m3" value="1">
</p>

<button onclick="snap()">SNAP</button>

<div id="cards"></div>
<div id="info"></div>

<h3>History</h3>
<div id="history"></div>

<script>
const WORKER="https://vp-hold.azimaymen.workers.dev";
const video=document.getElementById("video");

navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>video.srcObject=s);

const history=[];

function vibrate(p){ navigator.vibrate && navigator.vibrate(p); }

function snap(){
  vibrate(10);
  const c=document.createElement("canvas");
  c.width=video.videoWidth;
  c.height=video.videoHeight/2;
  c.getContext("2d").drawImage(video,0,video.videoHeight/4,c.width,c.height,0,0,c.width,c.height);

  fetch(WORKER,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      imageBase64:c.toDataURL("image/jpeg",0.6),
      multipliers_fallback:[
        m1.value,m2.value,m3.value
      ]
    })
  }).then(r=>r.json()).then(d=>{
    vibrate([30,20,30]);
    render(d);
    history.unshift(d);
    renderHistory();
  });
}

function render(d){
  cards.innerHTML="";
  d.cards.forEach((c,i)=>{
    const div=document.createElement("div");
    div.className="card"+(d.hold[i]?" hold":"");
    div.innerHTML=c.rank+c.suit;
    cards.appendChild(div);
  });
  info.innerHTML=`Total ${d.multiplier_total}Ã— (${d.mode_badge}) EV ${d.ev_total.toFixed(2)}`;
}

function renderHistory(){
  historyDiv.innerHTML="";
  history.forEach(h=>{
    const p=document.createElement("p");
    p.textContent=h.cards.map(c=>c.rank+c.suit).join(" ");
    historyDiv.appendChild(p);
  });
}

const cards=document.getElementById("cards");
const info=document.getElementById("info");
const historyDiv=document.getElementById("history");
</script>

</body>
</html>
