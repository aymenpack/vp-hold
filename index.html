<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Video Poker Assistant</title>

<style>
:root{
  --bg:#0b0f14; --panel:#121a24; --border:#223043; --text:#e9eef6; --muted:#b7c3d7;
  --accent:#2f6bff; --ok:#22c55e; --warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui}
.app{max-width:980px;margin:auto;padding:12px 12px 120px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;margin-bottom:12px}
h2{margin:0 0 8px;font-size:14px;color:#cfe0ff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(min-width:900px){.row{grid-template-columns:1.2fr 1fr 1fr 1fr}}
select,button,input{
  width:100%;background:#0f1621;color:var(--text);
  border:1px solid var(--border);border-radius:12px;padding:10px;font-size:14px;
}
button.primary{background:var(--accent);border-color:var(--accent)}
button.ghost{background:rgba(18,26,36,.6)}
video,canvas,img{width:100%;border-radius:12px;border:1px solid var(--border);background:#000}
.hand{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:8px}
.card{
  border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;position:relative;
  min-height:74px;display:flex;flex-direction:column;justify-content:center;gap:6px;
}
.card.hold{outline:2px solid var(--ok)}
.card .idx{position:absolute;top:6px;left:8px;font-size:11px;color:var(--muted)}
.card .face{font-size:22px;font-weight:800}
.status{font-size:12px;color:var(--muted);margin-top:6px}
.pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
.pill strong{color:#fff}
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
</style>
</head>

<body>
<div class="app">

<!-- GAME / PAYTABLE -->
<div class="panel">
  <h2>Game & Paytable</h2>
  <div class="row">
    <select id="game"></select>
    <select id="paytable"></select>
    <select id="speed">
      <option value="fast">Fast</option>
      <option value="med" selected>Medium</option>
      <option value="high">High</option>
    </select>
    <button class="ghost" id="autoBtn">Auto Solve: ON</button>
  </div>
</div>

<!-- CAMERA -->
<div class="panel">
  <h2>Camera</h2>
  <video id="video" playsinline autoplay muted style="display:none"></video>
  <canvas id="canvas" style="display:none"></canvas>

  <div class="row">
    <button class="primary" id="startCam">Start Camera</button>
    <button id="snap" disabled>Snap</button>
  </div>
  <div class="status" id="status">Waiting…</div>
</div>

<!-- HAND -->
<div class="panel">
  <h2>Hand</h2>
  <div class="hand" id="hand"></div>

  <div id="uxBox" style="display:none;margin-top:10px">
    <div class="status"><strong>Ultimate X multiplier</strong></div>
    <input id="uxMult" type="number" min="1" step="1" value="1"/>
  </div>

  <div class="kpis">
    <span class="pill">EV: <strong id="ev">—</strong></span>
    <span class="pill">Hold: <strong id="holdText">—</strong></span>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="ghost" id="solveBtn">Solve Now</button>
    <button class="ghost" id="clearBtn">Clear</button>
  </div>
</div>

</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

/* ================= DATA ================= */
const GAMES = [
  {k:"job",n:"Jacks or Better"},
  {k:"bonus",n:"Bonus Poker"},
  {k:"double_bonus",n:"Double Bonus"},
  {k:"ddb",n:"Double Double Bonus"},
  {k:"deuces",n:"Deuces Wild"},
  {k:"ux",n:"Ultimate X"},
  {k:"uxp",n:"Ultimate X Progressive"}
];

const PAYTABLES = {
  job:[{k:"9_6",l:"9/6",pt:{}}],
  bonus:[{k:"std",l:"Standard",pt:{}}],
  double_bonus:[{k:"std",l:"Standard",pt:{}}],
  ddb:[{k:"std",l:"Standard",pt:{}}],
  deuces:[{k:"std",l:"Standard",pt:{}}],
  ux:[{k:"base",l:"Base 9/6",pt:{}}],
  uxp:[{k:"base",l:"Base 9/6",pt:{}}]
};

const SUIT_CHAR={S:"♠",H:"♥",D:"♦",C:"♣"};

/* ================= STATE ================= */
let hand=[null,null,null,null,null];
let hold=[false,false,false,false,false];
let uxMultiplier=1;
let autoSolve=true;

/* ================= ELEMENTS ================= */
const elGame=game, elPay=paytable, elHand=handDiv=document.getElementById("hand");
const elEV=ev, elHold=holdText, elUxBox=uxBox, elUxMult=document.getElementById("uxMult");
const statusEl=status;

/* ================= INIT ================= */
function initSelectors(){
  elGame.innerHTML="";
  GAMES.forEach(g=>{
    const o=document.createElement("option");
    o.value=g.k; o.textContent=g.n; elGame.appendChild(o);
  });
  elGame.value="job";
  rebuildPaytables();

  elGame.onchange=()=>{rebuildPaytables(); render(); solveIfReady();};
  elPay.onchange=()=>{solveIfReady();};
}
function rebuildPaytables(){
  elPay.innerHTML="";
  (PAYTABLES[elGame.value]||[]).forEach(p=>{
    const o=document.createElement("option");
    o.value=p.k; o.textContent=p.l; elPay.appendChild(o);
  });
}
initSelectors();

/* ================= CAMERA ================= */
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");

startCam.onclick=async()=>{
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=s; video.style.display=""; snap.disabled=false;
};

snap.onclick=async()=>{
  statusEl.textContent="Recognizing…";
  canvas.width=video.videoWidth; canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);

  const maxW=800, sc=Math.min(maxW/canvas.width,1);
  const t=document.createElement("canvas");
  t.width=canvas.width*sc; t.height=canvas.height*sc;
  t.getContext("2d").drawImage(canvas,0,0,t.width,t.height);
  const dataUrl=t.toDataURL("image/jpeg",0.7);

  const r=await fetch(WORKER_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({imageBase64:dataUrl})
  });
  const d=await r.json();

  if(d.cards){
    hand=d.cards.map(c=>({rank:c.rank,suit:c.suit}));
    if(d.multiplier!=null) uxMultiplier=parseInt(d.multiplier)||1;
    render();
    solveIfReady();
    statusEl.textContent="Done";
  }else{
    statusEl.textContent="Could not read cards. Tap to correct.";
  }
};

/* ================= RENDER ================= */
function render(){
  elHand.innerHTML="";
  const isUX=(elGame.value==="ux"||elGame.value==="uxp");
  elUxBox.style.display=isUX?"":"none";
  elUxMult.value=uxMultiplier;

  hand.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="card"+(hold[i]?" hold":"");
    d.innerHTML=`<div class="idx">${i+1}</div><div class="face">${c?c.rank+SUIT_CHAR[c.suit]:"—"}</div>`;
    d.onclick=()=>{
      const v=prompt("AS, 9D, KC:");
      if(v){hand[i]={rank:v[0].toUpperCase(),suit:v[1].toUpperCase()}; solveIfReady();}
    };
    elHand.appendChild(d);
  });
}

uxMult.onchange=()=>{uxMultiplier=parseInt(uxMult.value)||1; solveIfReady();};

/* ================= SOLVER ================= */
function solveIfReady(){
  if(hand.every(Boolean)){
    solve();
  }
}

function solve(){
  // simple but consistent baseline strategy
  hold=[false,false,false,false,false];
  const cnt={};
  hand.forEach(c=>cnt[c.rank]=(cnt[c.rank]||0)+1);
  hand.forEach((c,i)=>{if(cnt[c.rank]>1) hold[i]=true;});

  elEV.textContent=(uxMultiplier*1.0).toFixed(2);
  elHold.textContent=hold.map((h,i)=>h?i+1:null).filter(Boolean).join(",")||"none";
  render();
}

/* ================= BUTTONS ================= */
autoBtn.onclick=()=>{
  autoSolve=!autoSolve;
  autoBtn.textContent=autoSolve?"Auto Solve: ON":"Auto Solve: OFF";
};
solveBtn.onclick=solve;
clearBtn.onclick=()=>{hand=[null,null,null,null,null];hold=[false,false,false,false,false];render();};
</script>
</body>
</html>
