<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Video Poker Assistant</title>

<style>
:root{
  --bg:#0b0f14; --panel:#121a24; --border:#223043; --text:#e9eef6; --muted:#b7c3d7;
  --accent:#2f6bff; --ok:#22c55e; --warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui}
.app{max-width:900px;margin:auto;padding:12px 12px 160px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;margin-bottom:12px}
h2{margin:0 0 8px;font-size:14px;color:#cfe0ff}

.scanWrap{
  position:relative;
  width:100%;
  height:140px; /* ðŸ”¹ thin horizontal camera */
  overflow:hidden;
  border-radius:12px;
  border:1px solid var(--border);
  background:#000;
}
.scanWrap video{
  position:absolute;
  width:100%;
  height:auto;
  top:50%;
  transform:translateY(-50%);
}
.scanGuide{
  position:absolute;
  inset:0;
  border-top:2px dashed rgba(255,255,255,.25);
  border-bottom:2px dashed rgba(255,255,255,.25);
  pointer-events:none;
}
.scanLabel{
  position:absolute;
  bottom:6px;left:50%;
  transform:translateX(-50%);
  font-size:11px;color:var(--muted);
  background:rgba(0,0,0,.5);
  padding:3px 8px;border-radius:999px;
}

.hand{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.card{
  border:1px solid var(--border);border-radius:14px;padding:12px 6px;
  text-align:center;position:relative;cursor:pointer;
}
.card.hold{
  outline:3px solid var(--ok);
  box-shadow:0 0 14px rgba(34,197,94,.6);
  transform:translateY(-2px);
}
.holdBadge{
  position:absolute;top:6px;right:6px;
  background:var(--ok);color:#000;font-size:10px;
  padding:2px 6px;border-radius:999px;font-weight:800;
}
.face{font-size:22px;font-weight:800}
.status{font-size:12px;color:var(--muted);margin-top:6px}

.snapBtn{
  position:fixed;
  bottom:72px;left:50%;
  transform:translateX(-50%);
  width:74px;height:74px;border-radius:50%;
  background:var(--accent);border:none;
  box-shadow:0 10px 30px rgba(47,107,255,.6);
}
.snapBtn::after{
  content:"";display:block;width:52px;height:52px;
  background:#fff;border-radius:50%;margin:auto;
}
.snapBtn:disabled{opacity:.5}
</style>
</head>

<body>
<div class="app">

<!-- GAME -->
<div class="panel">
  <h2>Game</h2>
  <select id="game">
    <option value="job">Jacks or Better</option>
    <option value="bonus">Bonus Poker</option>
    <option value="double_bonus">Double Bonus</option>
    <option value="ddb">Double Double Bonus</option>
    <option value="deuces">Deuces Wild</option>
    <option value="ux">Ultimate X</option>
    <option value="uxp">Ultimate X Progressive</option>
  </select>
</div>

<!-- CAMERA STRIP -->
<div class="panel">
  <h2>Scan cards</h2>
  <div class="scanWrap">
    <video id="video" playsinline autoplay muted></video>
    <div class="scanGuide"></div>
    <div class="scanLabel">Align card row here</div>
  </div>
  <div class="status" id="status">Ready</div>
</div>

<!-- HAND -->
<div class="panel">
  <div class="hand" id="hand"></div>
</div>

</div>

<button class="snapBtn" id="snapBtn"></button>

<canvas id="canvas" style="display:none"></canvas>

<script>
/* ===== CONFIG ===== */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

/* ===== STATE ===== */
const SUIT={S:"â™ ",H:"â™¥",D:"â™¦",C:"â™£"};
let cards=[], hold=[], confidence=1;

/* ===== ELEMENTS ===== */
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const handDiv=document.getElementById("hand");
const statusEl=document.getElementById("status");

/* ===== CAMERA INIT ===== */
(async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"}
  });
  video.srcObject=stream;
})();

/* ===== SNAP ===== */
snapBtn.onclick=async()=>{
  navigator.vibrate?.(30);
  statusEl.textContent="Scanningâ€¦";

  // Capture ONLY the horizontal band
  const vw=video.videoWidth;
  const vh=video.videoHeight;

  const bandH=vh*0.35;
  const bandY=(vh-bandH)/2;

  canvas.width=vw;
  canvas.height=bandH;

  canvas.getContext("2d").drawImage(
    video,
    0,bandY,vw,bandH,
    0,0,vw,bandH
  );

  // Resize to max width 800
  const scale=Math.min(800/vw,1);
  const out=document.createElement("canvas");
  out.width=vw*scale;
  out.height=bandH*scale;
  out.getContext("2d").drawImage(canvas,0,0,out.width,out.height);

  const img=out.toDataURL("image/jpeg",0.7);

  const res=await fetch(WORKER_URL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      imageBase64:img,
      game:game.value,
      paytable:"standard"
    })
  });

  const d=await res.json();
  cards=d.cards||[];
  hold=d.hold||[];

  render();
  statusEl.textContent="Done";
};

/* ===== RENDER ===== */
function render(){
  handDiv.innerHTML="";
  cards.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="card"+(hold[i]?" hold":"");
    d.innerHTML=`
      ${hold[i]?'<div class="holdBadge">HOLD</div>':''}
      <div class="face">${c.rank}${SUIT[c.suit]}</div>
    `;
    d.onclick=()=>{hold[i]=!hold[i];render();};
    handDiv.appendChild(d);
  });
}
</script>
</body>
</html>
