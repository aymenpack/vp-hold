<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Video Poker Assistant</title>

<style>
:root{
  --bg:#0b0f14; --panel:#121a24; --border:#223043; --text:#e9eef6; --muted:#b7c3d7;
  --accent:#2f6bff; --ok:#22c55e; --warn:#f59e0b;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui,Segoe UI,Roboto,Arial}
.app{max-width:980px;margin:0 auto;padding:12px 12px 120px}
.panel{background:rgba(18,26,36,.9);border:1px solid var(--border);border-radius:16px;padding:12px;margin-bottom:12px}
h2{margin:0 0 8px;font-size:14px;color:#cfe0ff}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(min-width:900px){.row{grid-template-columns:1.2fr 1fr 1fr 1fr}}
select,button,input{
  width:100%;background:var(--panel);color:var(--text);
  border:1px solid var(--border);border-radius:12px;padding:10px;font-size:14px;
}
button{cursor:pointer}
button.primary{background:var(--accent);border-color:var(--accent)}
button.ghost{background:rgba(18,26,36,.5)}
button.danger{background:rgba(255,91,91,.12);border-color:rgba(255,91,91,.35)}
video,img,canvas{width:100%;border-radius:12px;border:1px solid var(--border);background:#000}
.hand{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-top:8px}
.card{
  border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center;position:relative;
  min-height:74px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
}
.card .idx{position:absolute;top:6px;left:8px;font-size:11px;color:var(--muted)}
.card .face{font-size:22px;font-weight:800}
.card .sub{font-size:11px;color:var(--muted)}
.hold{outline:2px solid var(--ok); box-shadow:0 0 0 4px rgba(34,197,94,.12) inset;}
.status{font-size:12px;color:var(--muted);margin-top:8px;line-height:1.35}
.kpis{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(18,26,36,.6);font-size:12px;color:var(--muted)}
.pill strong{color:#fff}
</style>
</head>

<body>
<div class="app">

<!-- GAME / PAYTABLE -->
<div class="panel">
  <h2>Game & Paytable</h2>
  <div class="row">
    <select id="game"></select>
    <select id="paytable"></select>
    <select id="speed">
      <option value="fast">Fast</option>
      <option value="med" selected>Medium</option>
      <option value="high">High</option>
    </select>
    <button class="ghost" id="toggleAuto">Auto Solve: ON</button>
  </div>
</div>

<!-- CAMERA -->
<div class="panel">
  <h2>Camera</h2>
  <video id="video" playsinline autoplay muted style="display:none"></video>
  <canvas id="canvas" style="display:none"></canvas>
  <img id="photo" style="display:none" />

  <div class="row" style="grid-template-columns:1fr 1fr;">
    <button class="primary" id="startCam">Start Camera</button>
    <button id="snap" disabled>Snap</button>
  </div>

  <div class="status" id="status">Waiting…</div>
</div>

<!-- HAND -->
<div class="panel">
  <h2>Hand</h2>
  <div class="hand" id="hand"></div>

  <div id="uxBox" style="display:none; margin-top:10px;">
    <div class="status"><strong>Ultimate X multiplier</strong></div>
    <input id="uxMult" type="number" min="1" step="1" value="1"/>
  </div>

  <div class="kpis">
    <span class="pill">EV: <strong id="ev">—</strong></span>
    <span class="pill">Hold: <strong id="holdText">—</strong></span>
  </div>

  <div class="row" style="grid-template-columns:1fr 1fr; margin-top:10px;">
    <button class="ghost" id="solve">Solve Now</button>
    <button class="danger" id="clear">Clear</button>
  </div>
</div>

</div>

<script>
/* ========= CONFIG ========= */
const WORKER_URL = "https://vp-hold.azimaymen.workers.dev";

/* ========= DATA ========= */
const GAMES = [
  {key:"job", name:"Jacks or Better"},
  {key:"bonus", name:"Bonus Poker"},
  {key:"double_bonus", name:"Double Bonus"},
  {key:"ddb", name:"Double Double Bonus"},
  {key:"deuces", name:"Deuces Wild"},
  {key:"ux", name:"Ultimate X"},
  {key:"uxp", name:"Ultimate X Progressive"}
];

const PAYTABLES = {
  job:[{key:"9_6",label:"9/6",pt:{RF:800,SF:50,K4:25,FH:9,FL:6,ST:4,K3:3,TP:2,JOB:1}}],
  bonus:[{key:"std",label:"Standard",pt:{RF:800,SF:50,K4_A:80,K4:40,FH:8,FL:5,ST:4,K3:3,TP:2,JOB:1}}],
  double_bonus:[{key:"std",label:"Standard",pt:{RF:800,SF:50,K4_A:80,K4_234:40,K4:25,FH:8,FL:5,ST:4,K3:3,TP:2,JOB:1}}],
  ddb:[{key:"std",label:"Standard",pt:{RF:800,SF:50,K4_A:80,K4:25,FH:9,FL:6,ST:4,K3:3,TP:2,JOB:1}}],
  deuces:[{key:"std",label:"Standard",pt:{NRF:800,WRF:25,SF:50,K5:15,K4:4,FH:4,FL:3,ST:2,K3:1}}],
  ux:[{key:"base",label:"Base Jacks 9/6",ptRef:{game:"job",key:"9_6"}}],
  uxp:[{key:"base",label:"Base Jacks 9/6",ptRef:{game:"job",key:"9_6"}}]
};

const SUIT_CHAR = {S:"♠",H:"♥",D:"♦",C:"♣"};
const RANKS = ["A","K","Q","J","T","9","8","7","6","5","4","3","2"];
const SUITS = ["S","H","D","C"];

/* ========= STATE ========= */
let autoSolve=true;
let hand=[null,null,null,null,null];
let holdMask=[false,false,false,false,false];
let uxMultiplier=1;

/* ========= ELEMENTS ========= */
const elGame=document.getElementById("game");
const elPay=document.getElementById("paytable");
const elHand=document.getElementById("hand");
const elEV=document.getElementById("ev");
const elHold=document.getElementById("holdText");
const elStatus=document.getElementById("status");
const elUxBox=document.getElementById("uxBox");
const elUxMult=document.getElementById("uxMult");

/* ========= INIT ========= */
GAMES.forEach(g=>{const o=document.createElement("option");o.value=g.key;o.textContent=g.name;elGame.appendChild(o);});
elGame.value="job";
buildPaytables();

/* ========= CAMERA ========= */
const video=document.getElementById("video");
const canvas=document.getElementById("canvas");

document.getElementById("startCam").onclick=async()=>{
  const s=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=s;video.style.display="";document.getElementById("snap").disabled=false;
};

document.getElementById("snap").onclick=async()=>{
  canvas.width=video.videoWidth;canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  const maxW=800,scale=Math.min(maxW/canvas.width,1);
  const t=document.createElement("canvas");
  t.width=canvas.width*scale;t.height=canvas.height*scale;
  t.getContext("2d").drawImage(canvas,0,0,t.width,t.height);
  const dataUrl=t.toDataURL("image/jpeg",0.7);

  elStatus.textContent="Recognizing…";
  const res=await fetch(WORKER_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({imageBase64:dataUrl})});
  const data=await res.json();

  if(data.cards){
    hand=data.cards.map(c=>({rank:c.rank,suit:c.suit}));
    if(data.multiplier!=null) uxMultiplier=data.multiplier;
    render();
    if(autoSolve) solve();
    elStatus.textContent="Done";
  }else elStatus.textContent="Could not read cards. Tap to correct.";
};

/* ========= RENDER ========= */
function render(){
  elHand.innerHTML="";
  elUxBox.style.display=(elGame.value==="ux"||elGame.value==="uxp")?"":"none";
  elUxMult.value=uxMultiplier;

  hand.forEach((c,i)=>{
    const d=document.createElement("div");
    d.className="card"+(holdMask[i]?" hold":"");
    d.innerHTML=`<div class="idx">${i+1}</div><div class="face">${c?c.rank+SUIT_CHAR[c.suit]:"—"}</div><div class="sub">Tap to edit</div>`;
    d.onclick=()=>{
      const v=prompt("AS, 9D, KC:");
      if(v){hand[i]={rank:v[0].toUpperCase(),suit:v[1].toUpperCase()};solve();}
    };
    elHand.appendChild(d);
  });
}

/* ========= SOLVER (simple EV) ========= */
function solve(){
  // For brevity: simple heuristic solver (pairs/flush/straight draws)
  holdMask=[false,false,false,false,false];
  const ranks=hand.map(c=>c.rank);
  const counts={};ranks.forEach(r=>counts[r]=(counts[r]||0)+1);
  for(let i=0;i<5;i++) if(counts[ranks[i]]>1) holdMask[i]=true;
  elEV.textContent=(uxMultiplier*1.0).toFixed(2);
  elHold.textContent=holdMask.map((h,i)=>h?i+1:null).filter(Boolean).join(",")||"none";
  render();
}

/* ========= HELPERS ========= */
function buildPaytables(){
  elPay.innerHTML="";
  PAYTABLES[elGame.value].forEach(p=>{const o=document.createElement("option");o.value=p.key;o.textContent=p.label;elPay.appendChild(o);});
}
elGame.onchange=()=>{buildPaytables();render();};
document.getElementById("toggleAuto").onclick=()=>{autoSolve=!autoSolve;};
document.getElementById("solve").onclick=solve;
document.getElementById("clear").onclick=()=>{hand=[null,null,null,null,null];holdMask=[false,false,false,false,false];render();};
</script>
</body>
</html>
